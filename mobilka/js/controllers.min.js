window.filterNoRequest=!1;var filterFlag=!1,thisPagerLink;angular.module("ctrl.filterCtrl",[]).controller("filterCtrl",["$compile","$element","$scope","$http","$attrs","$timeout","$parse","$location","filterSrv",function($compile,$element,$scope,$http,$attrs,$timeout,$parse,$location,filterSrv){$scope.filterForm={},$scope.filterForm=filterSrv,$scope.filterData={},$scope.filterResult={},$scope.popState=!1;var currentRange,origFilterData={},allRanges={},singleSelects=0,passedSelects=0;function renderTabHeaders(){var template=document.createElement("template"),wrapperEl='<div class="box-tabs box-tabs--search" id="searchTabsForEvents" data-init-tabs="" >\n            <div class="elem-tab__head">\n                <div class="swiper-container">\n                    <div class="swiper-wrapper">\n'+$scope.filterResult.subsectionHtml+"                    </div>\n                </div>\n            </div>\n        </div>";template.innerHTML=wrapperEl;var elem=template.content?template.content.firstChild:template.firstChild,content=$compile(angular.element(elem))($scope);$(".box-tabs--search").replaceWith(content)}$scope.recalculateLoaderPosition=function(){var boxSnippetsLoader=$("<div class='box-snippets__loader' />");0==$(".box-snippets").children(".box-snippets__loader").length&&$(".box-snippets").prepend(boxSnippetsLoader),setTimeout(function(){var loaderTop=$(".box-snippets").offset().top-(window.scrollY||window.pageYOffset||document.body.scrollTop),loaderLeft=$(".box-snippets").offset().left-(window.scrollX||window.pageXOffset||document.body.scrollLeft),loaderBottom=$(window).height()-$(".box-snippets").height()-loaderTop,loaderRight=$(window).width()-$(".box-snippets").width()-loaderLeft;$(".box-snippets__loader").css({top:loaderTop<0?0:loaderTop+"px",left:loaderLeft<0?0:loaderLeft+"px",bottom:loaderBottom<0?0:loaderBottom+"px",right:loaderRight<0?0:loaderRight+"px"})},300)},$scope.initModel=function(objFilter,objResult,test){for(var key in origFilterData=window[objFilter],$scope.filterData=angular.copy(window[objFilter]),$scope.filterResult=window[objResult],$scope.countResult=Object.keys($scope.filterResult.SELECTED).length,origFilterData)origFilterData[key].VALUES.hasOwnProperty("MIN")&&0<(currentRange=$element.find('[data-key="'+key+'"]').next("[data-slider]")).length&&(allRanges[key]={},allRanges[key].MIN=currentRange.data("start"),allRanges[key].MAX=currentRange.data("end"));for(var key in $scope.filterResult.SELECTED)$scope.filterResult.SELECTED[key].hasOwnProperty("sliderInfo")&&($scope.filterData[key].VALUES.MIN.VALUE=+$scope.filterResult.SELECTED[key].MIN,$scope.filterData[key].VALUES.MAX.VALUE=+$scope.filterResult.SELECTED[key].MAX);refreshRangeInformers(),initTabPoints(),(-1<getBrowserInfo().indexOf("IE ")||-1<getBrowserInfo().indexOf("Safari"))&&$("select",$element).each(function(){isMulti($(this).attr("multiple"))||singleSelects++})},$scope.initSelect=function(modelName,val){$timeout(function(){$scope[modelName]=null==val?"":val},1),$timeout(function(){$element.find(".selectpicker").selectpicker("render")},2)},$scope.getUrlForFilterize=function(){return $timeout(function(){var selectedLINK=[];$(".range-output",$element).each(function(){var equalMIN=!1,equalMAX=!1,linkKey="",linkValue="";(rangeKey=$(this).data("key"),inpMin=$(this).find('[type="tel"]').first(),inpMax=$(this).find('[type="tel"]').last(),""===$scope.filterData[rangeKey].VALUES.MAX.VALUE&&($scope.filterData[rangeKey].VALUES.MAX.VALUE=+allRanges[rangeKey].MAX),+$scope.filterData[rangeKey].VALUES.MIN.VALUE<+allRanges[rangeKey].MIN&&inpMin.val(allRanges[rangeKey].MIN),+$scope.filterData[rangeKey].VALUES.MAX.VALUE>+allRanges[rangeKey].MAX&&inpMax.val(allRanges[rangeKey].MAX),+$scope.filterData[rangeKey].VALUES.MIN.VALUE<=+allRanges[rangeKey].MIN&&(equalMIN=!0),+$scope.filterData[rangeKey].VALUES.MAX.VALUE>=+allRanges[rangeKey].MAX&&(equalMAX=!0),equalMIN&&equalMAX)?(inpMin.prop("disabled",!0),inpMax.prop("disabled",!0)):(linkKey=$scope.filterData[rangeKey].VALUES.MIN.HUMAN_CODE,linkValue+=+inpMin.val()>+inpMax.val()?inpMax.val()+"_"+inpMin.val():inpMin.val()+"_"+inpMax.val(),""!==linkKey&&""!==linkValue&&selectedLINK.push(linkKey+"="+encodeURIComponent(linkValue)))}),$("select",$element).each(function(){var attr=$(this).attr("multiple"),linkKeyAdded=!1,linkKey="",linkValue="",modelName=$(this).data("ngModel");if($scope.filterData[modelName])for(var key in $scope.filterData[modelName].VALUES){var currentKey=$scope.filterData[modelName].VALUES[key];if(currentKey.VALUE_ID!=$scope[modelName]||isMulti(attr)){if(isMulti(attr))for(var i=0;i<$scope[modelName].length;i++)currentKey.VALUE_ID==$scope[modelName][i]&&(linkKeyAdded||(linkKey=currentKey.HUMAN_CODE,linkKeyAdded=!0),linkValue+=","+currentKey.HTML_VALUE)}else linkKeyAdded||(linkKey=currentKey.HUMAN_CODE,linkKeyAdded=!0),linkValue+=","+currentKey.HTML_VALUE}$(this).parent().hasClass("open")&&$(this).parent().children("button").trigger("click"),linkValue=linkValue.substring(1),""!==linkKey&&""!==linkValue&&selectedLINK.push(linkKey+"="+encodeURIComponent(linkValue))}),selectedLINK=selectedLINK.join("&"),$scope.filterForm.filterSearchParams=selectedLINK;var locSearchObj={},searchLink="";if(0<location.search.length&&(locSearchObj=searchToObject(window.location.search)),""!=location.search||filterFlag){if(""!=location.search&&!filterFlag){for(var key in filterFlag=!0,0<selectedLINK.length&&(selectedLINK="&"+selectedLINK),locSearchObj)"search"!=key&&"fromSearch"!=key&&"section_id"!=key&&"onlyGreen"!=key&&"tovary_so_skidkoi"!=key&&"sort"!=key&&"offers"!=key&&"page"!=key||(searchLink+=key+"="+encodeURI(locSearchObj[key])+"&");var linkLength;""!=(searchLink=searchLink.slice(0,-1))&&($scope.filterResult.LINK=location.pathname+"?"+searchLink+selectedLINK+location.hash),""==searchLink&&("&"==selectedLINK[0]&&(selectedLINK=selectedLINK.substr(1)),$scope.filterResult.LINK=location.pathname+"?"+selectedLINK+location.hash),$scope.filterResult.LINK&&(linkLength=$scope.filterResult.LINK.length,"?"==$scope.filterResult.LINK.substr(linkLength-1)&&($scope.filterResult.LINK=$scope.filterResult.LINK.slice(0,-1)))}}else filterFlag=!0,$scope.filterResult.LINK=location.pathname+"?"+selectedLINK+location.hash})},$scope.filterize=function(param,isPager){var dataForSend,searchPopstate=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"",popState=3<arguments.length&&void 0!==arguments[3]&&arguments[3],data=4<arguments.length&&void 0!==arguments[4]?arguments[4]:"";if((-1<getBrowserInfo().indexOf("IE ")||-1<getBrowserInfo().indexOf("Safari"))&&passedSelects<singleSelects)return passedSelects++,$scope.loading=!1,$scope.filterForm.loading=!1,$(window).off("scroll resize",$scope.recalculateLoaderPosition),$element.removeClass("has-loader"),!(window.filterNoRequest=!0);if(0==window.filterNoRequest){var URL=$attrs.action;$(".collections").length||"Y"===data.isTab||($scope.recalculateLoaderPosition(),$(window).on("scroll resize",$scope.recalculateLoaderPosition),$element.addClass("has-loader")),$scope.getUrlForFilterize().then(function(){URL=$scope.filterResult.LINK,dataForSend=$element.serialize();var urlArray=[];if(URL&&(urlArray=URL.split("/")),-1<window.location.pathname.indexOf("/page")){var pathArray=window.location.pathname.split("/");for(URL="",i=0;i<pathArray.length-2;i++)URL+=pathArray[i],URL+="/";URL+=window.location.search,2<urlArray.length&&-1<urlArray[urlArray.length-2].indexOf("page")&&urlArray[urlArray.length-1]&&(URL+=urlArray[urlArray.length-1])}param&&isPager&&(URL=param,dataForSend=window.location.search.substring(1)+"&_AJAX=Y"),param&&popState&&!isPager&&(URL=param+"?"+searchPopstate.substring(1)+"&_AJAX=Y",dataForSend=searchPopstate.substring(1)+"&_AJAX=Y"),-1!==dataForSend.indexOf("onlyGreen=N")&&(dataForSend=dataForSend.slice(0,dataForSend.indexOf("onlyGreen=N")+10)+"false"+dataForSend.slice(dataForSend.indexOf("onlyGreen=N")+11))}).then(function(){""!=data&&(dataForSend=data),$http.post(URL,dataForSend).then(function(response){if($scope.filterResult=response.data,$scope.filterResult.LINK=URL,response.data.elementCount&&($scope.filterForm.elementCount=+response.data.elementCount),response.data.COUNT&&($scope.filterForm.COUNT=response.data.COUNT),response.data.title&&(document.title=response.data.title.split("&nbsp;").join(" ")),response.data.description&&$("meta[name='description']").prop("content",response.data.description.split("&nbsp;").join(" ")),response.data.keywords&&$("meta[name='keywords']").prop("content",response.data.keywords.split("&nbsp;").join(" ")),isPager&&(response.data.products&&0==response.data.products.length?$scope.filterForm.products="&nbsp;":response.data.products&&0<response.data.products.length?2==isPager?($scope.filterForm.products=$(".box-snippets").html(),$scope.filterForm.products=$scope.filterForm.products+response.data.products.replace("","<div class='box-snippets__loader'></div>")):$scope.filterForm.products=(0==$(".box-snippets").children(".box-snippets__loader").length?"<div class='box-snippets__loader'></div>":"")+response.data.products:$scope.filterForm.products="&nbsp;",response.data.pager&&0==response.data.pager.length?$scope.filterForm.pager="&nbsp;":response.data.pager&&0<response.data.pager.length?$scope.filterForm.pager=response.data.pager:$scope.filterForm.pager="&nbsp;",$scope.filterResult.RESULT=""),response.data.subsectionHtml&&0!=response.data.subsectionHtml.length&&($scope.filterResult.subsectionHtml=response.data.subsectionHtml,renderTabHeaders()),"Y"===dataForSend.isTab){response.data.titleForFilter&&0!=response.data.titleForFilter.length&&$(".elem-header").html(response.data.titleForFilter);var content=$compile(angular.element($(response.data.SELECTED)))($scope);$("div[data-form-filter]").replaceWith(content),$timeout(function(){angular.element(".form-filter").scope().filterData=window.objCatalogFilter,angular.element(".form-filter").scope().filterResult=window.objResult,angular.element(".form-filter").scope().initModel("objCatalogFilter","objResult"),rebuildResultModel(!1),checkRanges(),$(".form-filter").removeClass("has-loader")})}else if(popState){response.data.titleForFilter&&0!=response.data.titleForFilter.length&&$(".elem-header").html(response.data.titleForFilter),window.objResult.SELECTED=JSON.parse(response.data.SELECTED.trim())[0].objResult,window.objCatalogFilter=JSON.parse(response.data.SELECTED.trim())[1].objCatalogFilter,$scope.initModel("objCatalogFilter","objResult");var locSearchObj={};for(var key in 0<searchPopstate.length&&(locSearchObj=searchToObject(searchPopstate)),window.objCatalogFilter)$scope[key]="";for(var key in window.objResult.SELECTED)$scope[window.objResult.SELECTED[key].NAME_CODE]=window.objResult.SELECTED[key].VALUES_LIST;for(var key in $("#sortSelect").val("popular"),angular.element(".form-sort").scope().sortBy="popular",$scope.filterForm.onlyGreen="N",locSearchObj)"search"==key||"fromSearch"==key||"section_id"==key||"onlyGreen"==key||"offers"==key||"page"==key?$timeout(function(){$scope.filterForm[key]=locSearchObj[key]},1):"sort"==key?($("#sortSelect").val(locSearchObj[key]),angular.element(".form-sort").scope().sortBy=locSearchObj[key]):"tovary_so_skidkoi"==key&&($("#sortSelect").val("discount"),angular.element(".form-sort").scope().sortBy="discount"),"onlyGreen"==key&&($scope.filterForm.onlyGreen="Y");$(".page-wrapper").removeClass("has-loader")}else rebuildResultModel(isPager),checkRanges();$timeout(function(){$(".selectpicker").selectpicker("render"),$(".range-output",$element).each(function(){$(this).find('[type="tel"]').prop("disabled",!1)})},100),$timeout(function(){0==$(".nav-pager .nav-pager__link.active").next().length?$(".show_more").hide():$(".show_more").show()},100),$scope.loading=!1,$scope.filterForm.loading=!1,$(window).off("scroll resize",$scope.recalculateLoaderPosition),$element.removeClass("has-loader"),$("body").removeClass("has-loader"),isPager&&2!==isPager&&$("html, body").animate({scrollTop:$(".box-snippets").offset().top-80},500),filterFlag=!1,$timeout(function(){window.filterNoRequest=!1},100),$timeout(refreshRangeInformers,10)},function(){$(".range-output",$element).each(function(){$(this).find('[type="tel"]').prop("disabled",!1)}),$scope.loading=!1,$scope.filterForm.loading=!1,$(window).off("scroll resize",$scope.recalculateLoaderPosition),$element.removeClass("has-loader"),$("body").removeClass("has-loader")})}),window.filterNoRequest=!0}},$scope.removeParam=function(section,paramName){if(!0===$scope.filterData[section].SINGLE)$scope[section]="";else for(var i=0;i<$scope[section].length;i++)$scope[section][i]==paramName&&($scope[section][i]=null);$timeout(function(){$scope.filterize()},0)},$scope.removeRange=function(section,limit,$event){var clickedElement=angular.element($event.currentTarget);"min"==limit&&($scope.filterData[section].VALUES.MIN.VALUE=allRanges[section].MIN,clickedElement.closest(".info-from").hide()),"max"==limit&&($scope.filterData[section].VALUES.MAX.VALUE=allRanges[section].MAX,clickedElement.closest(".info-to").hide()),$scope.filterData[section].VALUES.MIN.VALUE==allRanges[section].MIN&&$scope.filterData[section].VALUES.MAX.VALUE==allRanges[section].MAX&&delete selectedJS[section],$timeout(function(){$scope.filterize()},0)};var rangeKey,inpMin,inpMax,selectedJS={};function rebuildResultModel(isPager){for(var item in $element.hasClass("form-filter")&&(checkRanges(),$(".range-output",$element).each(function(){var curentElement=$(this),rangeKey=curentElement.data("key"),curentScopeElement=$scope.filterData[rangeKey],inpMin=curentElement.find('[type="tel"]').first(),inpMax=curentElement.find('[type="tel"]').last();1!=inpMin.prop("disabled")&&(selectedJS[rangeKey]={sliderInfo:!0,NAME:curentScopeElement.NAME,MIN:+curentScopeElement.VALUES.MIN.VALUE,MAX:+curentScopeElement.VALUES.MAX.VALUE,NAME_CODE:rangeKey,TAB:curentScopeElement.TAB},"9{1,6}[.][0|9]"===inpMin.data("maskInput")&&(selectedJS[rangeKey].MIN=decimalZero(curentScopeElement.VALUES.MIN.VALUE)),"9{1,6}[.][0|9]"===inpMax.data("maskInput")&&(selectedJS[rangeKey].MAX=decimalZero(curentScopeElement.VALUES.MAX.VALUE)))}),$("select",$element).each(function(){var attr=$(this).attr("multiple"),rangeKey=$(this).data("ngModel"),curentScopeElement=$scope.filterData[rangeKey];for(var key in selectedJS[rangeKey]={NAME:curentScopeElement.NAME,VALUES:{},NAME_CODE:rangeKey,TAB:curentScopeElement.TAB},curentScopeElement.VALUES){var currentKey=curentScopeElement.VALUES[key];if(currentKey.VALUE_ID!=$scope[rangeKey]||isMulti(attr)){if(isMulti(attr))for(var keyIn in $scope[rangeKey])currentKey.VALUE_ID==$scope[rangeKey][keyIn]&&(selectedJS[rangeKey].VALUES[key]={VALUE_ID:currentKey.VALUE_ID,CONTENT:currentKey.VALUE_CONTENT,TAB:curentScopeElement.TAB})}else selectedJS[rangeKey].VALUES[key]={VALUE_ID:currentKey.VALUE_ID,CONTENT:currentKey.VALUE_CONTENT,TAB:curentScopeElement.TAB}}""!=$scope[rangeKey]&&0!=Object.getOwnPropertyNames(selectedJS[rangeKey].VALUES).length||delete selectedJS[rangeKey]})),$scope.filterResult.SELECTED=selectedJS,$scope.filterResult.SELECTED)if(void 0!==$scope.filterResult.SELECTED[item]&&+$scope.filterResult.SELECTED[item].MIN>+$scope.filterResult.SELECTED[item].MAX){var temp=+$scope.filterResult.SELECTED[item].MAX;$scope.filterResult.SELECTED[item].MAX=+$scope.filterResult.SELECTED[item].MIN,$scope.filterResult.SELECTED[item].MIN=+temp}if(void 0!==selectedJS&&($scope.countResult=Object.keys(selectedJS).length),!isPager){-1!==getBrowserInfo().indexOf("Safari")&&$scope.filterResult.LINK&&"?"==$scope.filterResult.LINK[$scope.filterResult.LINK.length-1]&&($scope.filterResult.LINK=$scope.filterResult.LINK.slice(0,-1));var myPathname="";if(-1<window.location.pathname.indexOf("/page")){var pathArray=window.location.pathname.split("/");for(i=0;i<pathArray.length-2;i++)myPathname+=pathArray[i],myPathname+="/";myPathname+=window.location.search}0==$(".nav-pager").children().length||"1"==$(".nav-pager").children(".active").text()?(myPathname=myPathname.slice(0,-1===myPathname.indexOf("?")?myPathname.length:myPathname.indexOf("?")),myPathname+=window.location.search):(myPathname=myPathname.slice(0,-1===myPathname.indexOf("?")?myPathname.length:myPathname.indexOf("?")),myPathname+="page"+$(".nav-pager").children(".active").text()+"/"+window.location.search)}initTabPoints(selectedJS)}function isMulti(attr){return void 0!==attr&&!1!==attr}function checkRanges(){$timeout(function(){$(".range-output",$element).each(function(){var curentElement=$(this),rangeKey=curentElement.data("key"),curentScopeElement=$scope.filterData[rangeKey],inpMin=curentElement.find('[type="tel"]').first(),inpMax=curentElement.find('[type="tel"]').last(),tempRangeVal=-1,equalMIN=!1,equalMAX=!1;curentElement.removeClass("has-error"),+inpMax.val()<+inpMin.val()&&(tempRangeVal=+curentScopeElement.VALUES.MIN.VALUE,curentScopeElement.VALUES.MIN.VALUE=+curentScopeElement.VALUES.MAX.VALUE,curentScopeElement.VALUES.MAX.VALUE=tempRangeVal),+curentScopeElement.VALUES.MIN.VALUE<=+allRanges[rangeKey].MIN?(equalMIN=!0,curentScopeElement.VALUES.MIN.VALUE=+allRanges[rangeKey].MIN,$("."+rangeKey+".info-from").hide()):$("."+rangeKey+".info-from").show(),+curentScopeElement.VALUES.MAX.VALUE>=+allRanges[rangeKey].MAX?(equalMAX=!0,curentScopeElement.VALUES.MAX.VALUE=+allRanges[rangeKey].MAX,$("."+rangeKey+".info-to").hide()):$("."+rangeKey+".info-to").show(),equalMIN&&equalMAX&&(delete selectedJS[rangeKey],inpMin.prop("disabled",!0),inpMax.prop("disabled",!0)),"9{1,6}[.][0|9]"===inpMin.data("maskInput")&&(curentScopeElement.VALUES.MIN.VALUE=decimalZero(curentScopeElement.VALUES.MIN.VALUE),curentScopeElement.VALUES.MAX.VALUE=decimalZero(curentScopeElement.VALUES.MAX.VALUE))})},0)}function initTabPoints(argument_0){var selectedJS=0<arguments.length&&void 0!==argument_0?argument_0:$scope.filterResult.SELECTED;$timeout(function(){var filterSection=$(".form-filter__section"),filterTriger=$(".form-filter__trigger");filterSection.each(function(e,item){$(item).removeClass("selected")}),filterTriger.removeClass("selected"),Object.keys(selectedJS).forEach(function(tab){var filterSectionCurrent=filterSection.eq(Number(selectedJS[tab].TAB)-1);filterSectionCurrent.hasClass("selected")||(filterSectionCurrent.addClass("selected"),filterTriger.hasClass("selected")||filterTriger.addClass("selected"))})},0)}function refreshRangeInformers(){$timeout(function(){for(var key in allRanges)$scope.filterData[key].VALUES.MIN.VALUE==allRanges[key].MIN?$(".info-from."+key).hide():$(".info-from."+key).show(),$scope.filterData[key].VALUES.MAX.VALUE==allRanges[key].MAX?$(".info-to."+key).hide():$(".info-to."+key).show()},1)}1==getCookie("is_product_list")&&("IE"===getBrowserInfo().split(" ")[0]||"MSIE"===getBrowserInfo().split(" ")[0]?$scope.filterForm.listView=!1:$scope.filterForm.listView=!0,$timeout(function(){$(window).resize()},200)),$scope.setView=function(type){"list"===type?($scope.filterForm.listView=!0,setCookie("is_product_list",1,{expires:2592e3,path:"/"})):"brick"===type&&($scope.filterForm.listView=!1,setCookie("is_product_list",0,{expires:2592e3,path:"/"})),$timeout(function(){$(window).resize()},200)},$element.hasClass("form-sort--lk")&&viewportWidth<=1280&&1==getCookie("is_product_list")&&($scope.filterForm.listView=!1),$(window).resize(function(){setTimeout(function(){$element.hasClass("form-sort--lk")&&1280<viewportWidth&&1==getCookie("is_product_list")&&($scope.filterForm.listView=!0),$element.hasClass("form-sort--lk")&&viewportWidth<=1280&&1==getCookie("is_product_list")&&($scope.filterForm.listView=!1)},100)}),$scope.selectRedirect=function(model,elemID,isLanding,hash){var $el=$("#"+elemID);if(null!=model){for(var m,queryParameters={},queryString=location.search.substring(1),re=/([^&=]+)=([^&]*)/g;m=re.exec(queryString);)queryParameters[decodeURIComponent(m[1])]=decodeURIComponent(m[2]);if("discount"==model)for(var key in queryParameters.tovary_so_skidkoi=1,queryParameters)"sort"==key&&delete queryParameters[key];else if("popular"!=model)queryParameters[$el.attr("name")]=model;else for(var key in queryParameters)"sort"==key&&delete queryParameters[key];if("sortSelect"==elemID&&"discount"!=model)for(var key in queryParameters)"tovary_so_skidkoi"==key&&delete queryParameters[key];if("N"==model)for(var key in queryParameters)"onlyGreen"==key&&delete queryParameters[key];if("1"==isLanding){for(var key in queryParameters)"perPage"==key&&delete queryParameters[key];queryParameters.page="all"}else for(var key in queryParameters)"page"==key&&delete queryParameters[key];var _params=$.param(queryParameters);_params=_params.replace(/(%2B)/g,"+");var _newPath=location.pathname,_regExt=new RegExp("/page([0-9]+)","g");_newPath=_newPath.replace(_regExt,""),_params&&""!=_params&&(_newPath+="?"+_params),location.href=hash?_newPath+hash:_newPath}},$scope.perPageRedirect=function(data,ajaxURL,hash){null!=data.mn&&$http.post(ajaxURL,data).then(function(result){if("OK"==result.data.RESULT){var newUrl=location.href.replace(/&?#showFirst/i,"");if(newUrl=newUrl.replace(/&?#showLast/i,""),location.href=hash?newUrl.split("#")[0]+hash:newUrl,result.data.CALLBACK)return new Function(result.data.CALLBACK)();location.reload()}})},$scope.selectAjax=function(model,elemID,isLanding,hash){var $el=$("#"+elemID);if(null!=model){$scope.filterForm.loading=!0,$scope.recalculateLoaderPosition(),$(window).on("scroll resize",$scope.recalculateLoaderPosition);for(var m,queryParameters={},queryString=location.search.substring(1),re=/([^&=]+)=([^&]*)/g;m=re.exec(queryString);)queryParameters[decodeURIComponent(m[1])]=decodeURIComponent(m[2]);if("discount"==model)for(var key in queryParameters.tovary_so_skidkoi=1,queryParameters)"sort"==key&&delete queryParameters[key];else if("popular"!=model)queryParameters[$el.attr("name")]=model;else for(var key in queryParameters)"sort"==key&&delete queryParameters[key];if("sortSelect"==elemID&&"discount"!=model)for(var key in queryParameters)"tovary_so_skidkoi"==key&&delete queryParameters[key];if("N"==model)for(var key in queryParameters)"onlyGreen"==key&&delete queryParameters[key];if("1"==isLanding){for(var key in queryParameters)"perPage"==key&&delete queryParameters[key];queryParameters.page="all"}else for(var key in queryParameters)"page"==key&&delete queryParameters[key];var _params=$.param(queryParameters);_params=_params.replace(/(%2B)/g,"+");var _newPath=location.pathname,_regExt=new RegExp("/page([0-9]+)","g");_newPath=_newPath.replace(_regExt,""),_params&&""!=_params&&(_newPath+="?"+_params);var newUrl="";"discount"!==model&&$('[name="tovary_so_skidkoi"]').length&&$('[name="tovary_so_skidkoi"]').val(0),newUrl="popular"==model&&""==_params?_newPath+"?_AJAX=Y":"popular"==model&&""!=_params?_newPath+"&_AJAX=Y":-1!==_newPath.indexOf("?")?_newPath+"&_AJAX=Y":_newPath+"?_AJAX=Y",""!==$scope.filterForm.filterSearchParams&&(newUrl+="&"+$scope.filterForm.filterSearchParams),$http.get(newUrl).then(function(response){document.title=response.data.title,response.data.elementCount&&($scope.filterForm.elementCount=+response.data.elementCount),response.data.COUNT&&($scope.filterForm.COUNT=response.data.COUNT),"OK"==response.data.RESULT&&(response.data.products&&0==response.data.products.length?$scope.filterForm.products="&nbsp;":response.data.products&&0<response.data.products.length?$scope.filterForm.products=response.data.products:$scope.filterForm.products="&nbsp;",response.data.pager&&0==response.data.pager.length?$scope.filterForm.pager="&nbsp;":response.data.pager&&0<response.data.pager.length?$scope.filterForm.pager=response.data.pager:$scope.filterForm.pager="&nbsp;",response.data.titleForFilter&&0!=response.data.titleForFilter.length&&angular.element(document.querySelector(".elem-header")).html(response.data.titleForFilter),response.data.subsectionHtml&&0!=response.data.subsectionHtml.length&&($scope.filterResult.subsectionHtml=response.data.subsectionHtml,renderTabHeaders()),hash?history.pushState(null,null,_newPath+hash):history.pushState(null,null,_newPath)),$scope.filterForm.loading=!1,$(window).off("scroll resize",$scope.recalculateLoaderPosition)},function(){$scope.filterForm.loading=!1,$(window).off("scroll resize",$scope.recalculateLoaderPosition)})}},$scope.perPageAjax=function(data,ajaxURL){if(null!=data.mn){for(var m,queryParameters={},queryString=location.search.substring(1),re=/([^&=]+)=([^&]*)/g;m=re.exec(queryString);)queryParameters[decodeURIComponent(m[1])]=decodeURIComponent(m[2]);var _params=$.param(queryParameters);_params=_params.replace(/(%2B)/g,"+");var _newPath=location.pathname,_regExt=new RegExp("/page([0-9]+)","g");_newPath=_newPath.replace(_regExt,""),_params&&""!=_params&&(_newPath+="?"+_params),$scope.filterForm.loading=!0,$scope.recalculateLoaderPosition(),$(window).on("scroll resize",$scope.recalculateLoaderPosition);(function(ajaxURL,data){$scope.filterForm.loading=!0,$http.post(ajaxURL,data).then(function(response){if((response.data.elementCount&&($scope.filterForm.elementCount=+response.data.elementCount),response.data.COUNT&&($scope.filterForm.COUNT=response.data.COUNT),"OK"==response.data.RESULT)&&(response.data.products&&0==response.data.products.length?$scope.filterForm.products="&nbsp;":response.data.products&&0<response.data.products.length?$scope.filterForm.products=response.data.products:$scope.filterForm.products="&nbsp;",response.data.pager&&0==response.data.pager.length?$scope.filterForm.pager="&nbsp;":response.data.pager&&0<response.data.pager.length?$scope.filterForm.pager=response.data.pager:$scope.filterForm.pager="&nbsp;",response.data.titleForFilter&&0!=response.data.titleForFilter.length&&angular.element(document.querySelector(".elem-header")).html(response.data.titleForFilter),response.data.subsectionHtml&&0!=response.data.subsectionHtml.length&&($scope.filterResult.subsectionHtml=response.data.subsectionHtml,renderTabHeaders()),response.data.CALLBACK))return new Function(response.data.CALLBACK)();$scope.filterForm.loading=!1,pagePreloader(!1),elementPreloader(".box-snippets",!1),$(window).off("scroll resize",$scope.recalculateLoaderPosition)},function(){$scope.filterForm.loading=!1,$(window).off("scroll resize",$scope.recalculateLoaderPosition)})})(_newPath,data)}},$scope.selectCatalog=function($event,data,ajaxURL){window.location=ajaxURL},$(document).on("click",".box-social__all-link",function(e){$scope.filterForm.loading=!1,$(window).off("scroll resize",$scope.recalculateLoaderPosition),"filterCtrl"==(thisPagerLink=$(this)).parent().data("ngController")&&(filterFlag||(filterFlag=!0,e.preventDefault(),history.pushState(null,null,$(this).attr("href")),$timeout(function(){thisPagerLink.parent().removeClass("has-loader")},10),$scope.filterize($(this).attr("href"),!0)))}),$(".elem-tab__head a").click(function(){$scope.recalculateLoaderPosition(),$(window).on("scroll resize",$scope.recalculateLoaderPosition)})}]),$(document).on("click",".nav-pager__link",function(e){angular.element(".form-filter").length&&(angular.element(".form-filter").scope().filterForm.loading=!1,$(window).off("scroll resize",angular.element(".form-filter").scope().recalculateLoaderPosition)),"filterCtrl"==(thisPagerLink=$(this)).parent(".nav-pager").parent().data("ngController")&&(e.preventDefault(),filterFlag||(filterFlag=!0,history.pushState(null,null,$(this).attr("href")),setTimeout(function(){thisPagerLink.parent(".nav-pager").parent().removeClass("has-loader")},10),angular.element(".form-filter").length&&"filterCtrl"==angular.element(".form-filter").data("ngController")?angular.element(".form-filter").scope().filterize($(this).attr("href"),!0):angular.element(".box-snippets").length&&"filterCtrl"==angular.element(".box-snippets").data("ngController")&&angular.element(".box-snippets").scope().filterize($(this).attr("href"),!0)))}),$(document).on("click",".show_more a",function(e){e.preventDefault(),$("body").addClass("has-loader"),thisPagerLink=$(".nav-pager .nav-pager__link.active").next(),"filterCtrl"!=$(".nav-pager").parent().data("ngController")||$(".nav-pager .nav-pager__link.active").next().attr("href")&&(filterFlag||(filterFlag=!0,history.pushState(null,null,thisPagerLink.attr("href")),(angular.element(".form-filter").length?angular.element(".form-filter"):angular.element(".form-sort")).scope().filterize($(this).attr("href"),2)))}),window.addEventListener("popstate",function(state){var isFiltersOpened;$(".form-filter__bodies").length&&(isFiltersOpened="block"===$(".form-filter__bodies").children().first()[0].style.display,"Safari"===getBrowserInfo().split(" ")[0]&&$("body").hasClass("page-catalog")&&isFiltersOpened&&localStorage.setItem("isFiltersOpened",1)),0===$("body").find('[data-ng-controller="filterCtrl"]').length&&0===$("body").find('[ng-controller="filterCtrl"]').length||setTimeout(function(){angular.element(".form-filter").length&&angular.element(".form-filter").scope().filterize(state.srcElement.location.pathname,!0,state.srcElement.location.search,!0)},0)}),"Safari"===getBrowserInfo().split(" ")[0]&&$("body").hasClass("page-catalog")&&localStorage.getItem("isFiltersOpened")&&($(".form-filter__bodies").children().first().show(),localStorage.removeItem("isFiltersOpened")),angular.module("ctrl.favCtrl",[]).controller("favCtrl",["$rootScope","$scope","$http","$timeout","$element","$compile","favSrv","$location",function($rootScope,$scope,$http,$timeout,$element,$compile,favSrv,$location){if($scope.favModel=favSrv,$("#deleted").length){var deleted=$("#deleted").data("deleted");window.inFavorite.ids=window.inFavorite.ids.filter(function(id){return!deleted.includes(id)})}var frontData={};$scope.initFav=function(url){0==window.is_authorized?(null===localStorage.getItem("favObj")||0==JSON.parse(localStorage.getItem("favObj")).length?localStorage.setItem("favObj",JSON.stringify(favSrv.ids)):favSrv.ids=JSON.parse(localStorage.getItem("favObj")),favSrv._AJAX="Y","/favorites/"===location.pathname&&$http.post(url,favSrv).then(function(response){response.data.products&&($(".box-snippets").empty(),$(".box-snippets").append($compile(response.data.products)($scope))),response.data.pager&&$(".box-snippets").parent().append($compile(response.data.pager)($scope))},function(){})):favSrv.ids=window.inFavorite.ids},$scope.goToFav=function(event,linkUrl){0<$("#My_favorites").length&&"/personal/#My_favorites"===linkUrl&&!$("#My_favorites").hasClass("active")&&(event.preventDefault(),event.stopPropagation(),$("#My_favorites").click())},$scope.checkFav=function(itemID){contains.call($scope.favModel.ids,itemID)?($scope.added=!0,$element.addClass("active")):($scope.added=!1,$element.removeClass("active"))},$scope.toggleFav=function(url,itemID,$event,redirect){if($event)var clickedElement=angular.element($event.currentTarget);frontData.id=itemID,contains.call($scope.favModel.ids,itemID)?frontData.action="remove":frontData.action="add",$scope.loading=!0,0==window.is_authorized&&(null===localStorage.getItem("favObj")||0==JSON.parse(localStorage.getItem("favObj")).length?localStorage.setItem("favObj",JSON.stringify(favSrv.ids)):favSrv.ids=JSON.parse(localStorage.getItem("favObj")),frontData.favorites=favSrv.ids),$http.post(url,frontData).then(function(response){if("double"!==response.data.ERROR){if(favSrv.auth=response.data.auth,0==window.is_authorized?("add"==frontData.action?favSrv.ids.push(itemID):"remove"==frontData.action&&(favSrv.ids=removeFromArray(favSrv.ids,itemID)),localStorage.setItem("favObj",JSON.stringify(favSrv.ids))):favSrv.ids=response.data.ids,$scope.checkFav(itemID),null!=clickedElement&&("remove"===frontData.action?clickedElement.closest(".elem-product").addClass("has-null"):"add"===frontData.action&&clickedElement.closest(".elem-product").removeClass("has-null")),$scope.loading=!1,response.data.CALLBACK)return new Function(response.data.CALLBACK)()}else{if($scope.loading=!1,!$(".fav-tooltip").length){$element.append("<span class='fav-tooltip'>Артикул уже добавлен в избранное</span>")}$(".fav-tooltip").stop(!0).fadeIn(0).delay(3e3).fadeOut(500)}},function(){$scope.loading=!1})},$scope.$on("favoriteBroadcast:root",function(event,itemID){$scope.checkFav(itemID)})}]),angular.module("ctrl.faqCtrl",[]).controller("faqCtrl",["$element","$scope","$http","$timeout","$attrs",function($element,$scope,$http,$timeout,$attrs){var frontData,clickedElem;$scope.makeRequest=function($event,url,data){if($event&&(clickedElem=angular.element($event.currentTarget)),frontData=data,!clickedElem.hasClass("active")){$element.parents(".faq-element__preview");clickedElem.siblings().removeClass("active"),$http.post(url,frontData).then(function(response){response.data&&"ok"===response.data.status&&clickedElem.addClass("active")},function(){})}}}]),angular.module("ctrl.suggestCtrl",[]).controller("suggestCtrl",["$element","$scope","$sce","$http","$attrs","$q","$timeout","$rootScope","$compile",function($element,$scope,$sce,$http,$attrs,$q,$timeout,$rootScope,$compile){var suggestions,URL=$attrs.suggestUrl,URL_selected=$attrs.sendUrl,inCart=$attrs.incart,inOrder=$attrs.inorder,objSuggest=[],overAddToBasket=!1;function setFromEnter(){var temp_item={};void 0!==$element.find(".ac-state-focus").attr("id")?temp_item.id=$element.find(".ac-state-focus").attr("id"):temp_item.id=$element.find(".ac-menu-item").first().attr("id"),setCity(temp_item)}function setCity(item){""!==$element.find(".elem-suggest__input").val()&&($element.find(".elem-suggest__input").val(""),$(".box-citylist__list .elem-radio-city input").attr("checked",!1),$scope.cityID=item.id,!URL_selected||inCart||inOrder||$http.post(URL_selected,{location_id:item.id}).then(function(response){if(response.data.LOCATION_ID&&(location.href=location.pathname+location.search),response.data.CALLBACK){if("/basket/"===window.location.pathname||"/basket/order/"===window.location.pathname)return;return new Function(response.data.CALLBACK)()}},function(){}),URL_selected&&inCart&&$http.post(URL_selected,{location_id:item.id}).then(function(response){if($scope.$emit("callMakePost",{LOCATION_NAME:response.data.LOCATION_NAME}),response.data.CALLBACK){if("/basket/"===window.location.pathname||"/basket/order/"===window.location.pathname)return;return new Function(response.data.CALLBACK)()}},function(){}),URL_selected&&inOrder&&$http.post(URL_selected,{location_id:item.id}).then(function(response){if($rootScope.$broadcast("orderMakePost",{LOCATION_NAME:response.data.LOCATION_NAME}),response.data.CALLBACK){if("/basket/"===window.location.pathname||"/basket/order/"===window.location.pathname)return;return new Function(response.data.CALLBACK)()}},function(){}))}$scope.cityID=0,$scope.loading=!1,$(document).on("mouseenter",".elem-product__cart",function(){overAddToBasket=!0}),$(document).on("mouseleave",".elem-product__cart",function(e){$(e.relatedTarget).parents("#basket").length||(overAddToBasket=!1)}),document.addEventListener("keydown",function(e){$timeout(function(){var focusedElement=document.querySelector(".ac-state-focus"),acContainer=document.querySelector(".ac-container"),acMenuItem=document.querySelector(".ac-menu-item");if(("38"==e.keyCode||"40"==e.keyCode)&&focusedElement){$element.find(".elem-suggest__input").get()[0].selectionEnd=0;var acContainerHeight=acContainer.clientHeight,bias=acMenuItem.clientHeight*($(focusedElement).index()+1),draggerContainer=$element.find(".mCSB_draggerContainer"),dragger=$element.find(".mCSB_dragger"),scrolledContainer=document.querySelector(".ac-menu").parentElement;scrolledContainer.style.top=0<acContainerHeight-bias?0:acContainerHeight-bias+"px";var scrollValue=Math.abs(parseInt(scrolledContainer.style.top))/scrolledContainer.clientHeight;dragger.css({top:draggerContainer.height()*scrollValue+"px"})}},100)}),$timeout(function(){$element.find(".form-search__text").on("input",function(){$(this).val().length?$element.find(".elem-suggest__clear").show():$element.find(".elem-suggest__clear").hide()}),$element.find(".elem-suggest__clear").on("click",function(){$element.find(".form-search__text").val(""),$element.find(".elem-suggest__clear").hide()})},1),$scope.autocomplete_options={suggest:function(term){if(term.length<3)return;$scope.loading=!0;var deferred=$q.defer();return $http.post(URL,"?q="+term).then(function(response){objSuggest=response.data,(suggestions=function(term){var q=term.toLowerCase().trim(),results=[];q=replaceLetter(q);for(var i=0;i<objSuggest.length&&results.length<10;i++){var suggestItem=objSuggest[i],suggestItemName=suggestItem.name?suggestItem.name:suggestItem.NAME,suggestItemId=suggestItem.id?suggestItem.id:suggestItem.ID;results.push({label:suggestItemName,value:suggestItemName,id:suggestItemId})}return results}(term)).forEach(function(s){s.label=$sce.trustAsHtml(highlight(s.label,term))}),deferred.resolve(response),$scope.loading=!1},function(response){deferred.reject(response),$scope.loading=!1}),$q.when(deferred.promise).then(function(){return suggestions},function(data){return data})},on_attach:function(){$element.find(".ac-container").hasClass("elem-suggest__scroll")||($element.find(".ac-container").addClass("elem-suggest__scroll"),initScroll())},on_select:function(item){null!==localStorage.getItem("basket_order_location")&&localStorage.removeItem("basket_order_location"),setCity(item)}},$(document).on("click",".elem-suggest__submit",function(){$(".ac-container").hasClass("ng-hide")||setFromEnter()}),$(document).on("keyup",".elem-suggest__input",function(e){"Enter"===e.key&&setFromEnter()});var productData={};$scope.autocomplete_search={suggest:function(term){if(term.length<3)return;$scope.loading=!0,URL=isArticul(term)?"/ajax/search_titles_articul.php?articul="+("#"===term[0]?term.slice(1):term):$attrs.suggestUrl;var deferred=$q.defer();return $http.post(URL,"term="+term).then(function(response){objSuggest=response.data,(suggestions=function(term){term.toLowerCase().trim();for(var results=[],i=0;i<objSuggest.length;i++){var suggestLabel,suggestItem=objSuggest[i];if(suggestItem.prices){if("category"!==suggestItem.type&&isArticul(term)){var priceOld=suggestItem.prices.old?'<div class="price-old"><span class="line-through">'+suggestItem.prices.old+'<span class="rub">p</span></span></div>':"";suggestLabel='<article class="suggestion c-box-product"><div class="c-box-product__image"><img src="'+suggestItem.image+'"></div><div class="c-box-product__info"><span class="name">'+suggestItem.label+'</span><div class="articul">'+suggestItem.articul+'</div><div class="total">'+suggestItem.status_text+'</div></div><div class="c-box-product__counter"><div class="price">'+priceOld+'<div class="price-current"><span>'+suggestItem.prices.new+'<span class="rub">P</span></span></div></div></div><div class="c-box-product__cart"><div class="elem-product__cart"><svg aria-hidden="true" class="icon icon-basket"><use xlink:href="'+window.stp+'images/required/sprite.svg#basket"></use></svg></div></div></article>'}else suggestLabel='<article class="suggestion c-box-product c-box-product--simple">'+suggestItem.label+"</article>";results.push({label:suggestLabel,url:suggestItem.url,data:suggestItem,all:suggestItem.all_results,noMobile:suggestItem.disable_mobile})}}return results}(term)).forEach(function(s){s.label=$sce.trustAsHtml(highlight(s.label,term))}),deferred.resolve(response),$scope.loading=!1},function(response){deferred.reject(response),$scope.loading=!1}),$q.when(deferred.promise).then(function(){return suggestions},function(data){return data})},on_attach:function(){$element.find(".ac-container").hasClass("elem-suggest__scroll")||($element.find(".ac-container").addClass("elem-suggest__scroll"),initScroll())},on_select:function(item){overAddToBasket?(productData={id:item.data.id,xml_id:item.data.xml_id,getout:"basket"},$scope.addItem(productData)):location.href=item.url}};var isArticul=function(testString){return("#"===testString[0]?testString.slice(1):testString).split("").every(function(char){return"0123456789".includes(char)})};var closePopupBtn;function highlight(str,term){term=replaceLetter(term);var highlight_regex=new RegExp("("+term+")","gi");return str.replace(highlight_regex,'<span class="highlight">$1</span>')}function initScroll(){$element.find(".elem-suggest__scroll").addClass("elem-custom-scroll"),$element.find(".elem-custom-scroll").mCustomScrollbar({axis:"y",scrollButtons:{enable:!0},advanced:{updateOnContentResize:!0},scrollInertia:0,snapAmount:15,mouseWheel:{enable:!0}})}$scope.checkRequest=function(e){""==toJSON($element.serialize()).search&&e.preventDefault()},$scope.addItem=function(frontData){$http.post("/ajax/basket/add_offer.php",frontData).then(function(response){var data;data=response.data,popupConfig.inline.markup=data,$.magnificPopup.open(popupConfig),$timeout(function(){try{myLazyLoad.update()}catch(e){}},1),$scope.loading=!1,pagePreloader(!1)},function(){$scope.loading=!1,pagePreloader(!1)})};var scrollDistance=0;var popupConfig={removalDelay:200,key:"pCart",items:{},type:"inline",auto:!1,closeMarkup:'<button title="%title%" type="button" class="mfp-close"></button>',closeOnBgClick:!1,callbacks:{beforeOpen:function(){closePopupBtn=document.getElementsByClassName("mfp-close")[0];function preventScroll(){$("html").css({overflow:"hidden"}),$("body").hasClass("safari")?(scrollDistance=$(window).scrollTop(),$("body").css({position:"fixed",left:0,top:-1*scrollDistance,bottom:0,right:0})):$("body").addClass("no-scroll")}closePopupBtn?(closePopupBtn.click(),$timeout(function(){preventScroll()},200)):preventScroll()},open:function(){var _this=this;$compile(this.content)($scope),$(this.contentContainer).children(".box-popup").append('<button title="Закрыть (Esc)" type="button" class="mfp-close"></button>'),$timeout(function(){_this.contentContainer[0].className+=" popupIn"},200)},beforeClose:function(){this.contentContainer[0].className+=" popupOut",$("html")[0].removeAttribute("style"),$("body").hasClass("safari")?($("body").css({position:"",left:"",top:"",bottom:"",right:""}),$(window).scrollTop(scrollDistance)):$("body").removeClass("no-scroll")},afterClose:function(){delete $.magnificPopup.instance.popupsCache.pCart}},inline:{markup:""}};function replaceLetter(word){return word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=word.replace(/q/g,"й")).replace(/w/g,"ц")).replace(/e/g,"у")).replace(/r/g,"к")).replace(/t/g,"е")).replace(/y/g,"н")).replace(/u/g,"г")).replace(/i/g,"ш")).replace(/o/g,"щ")).replace(/з/g,"з")).replace(/\[/g,"х")).replace(/\]/g,"ъ")).replace(/a/g,"ф")).replace(/s/g,"ы")).replace(/d/g,"в")).replace(/f/g,"а")).replace(/g/g,"п")).replace(/h/g,"р")).replace(/j/g,"о")).replace(/k/g,"л")).replace(/l/g,"д")).replace(/\;/g,"ж")).replace(/\'/g,"э")).replace(/z/g,"я")).replace(/x/g,"ч")).replace(/c/g,"с")).replace(/v/g,"м")).replace(/b/g,"и")).replace(/n/g,"т")).replace(/m/g,"ь")).replace(/\./g,"ю")}}]),angular.module("ctrl.autoCompleteCtrl",[]).controller("autoCompleteCtrl",["$element","$scope","$sce","$http","$attrs","$q","$timeout","$rootScope","$compile",function($element,$scope,$sce,$http,$attrs,$q,$timeout,$rootScope,$compile){var URL=$attrs.suggestUrl,productData={},overAddToBasket=!1;$scope.loading=!1,$(document).on("mouseenter",".elem-product__cart",function(){overAddToBasket=!0}),$(document).on("mouseleave",".elem-product__cart",function(e){$(e.relatedTarget).parents("#basket").length||(overAddToBasket=!1)});function isArticul(testString){return("#"===testString[0]?testString.slice(1):testString).split("").every(function(char){return"0123456789".includes(char)})}var closePopupBtn,suggestElem=$element.children("#autocomplete")[0],searchTimer=null;function preventDefaultWrapper(e){e.preventDefault()}new Autocomplete(suggestElem,{search:function(input){return new Promise(function(resolve,reject){searchTimer&&clearTimeout(searchTimer),searchTimer=setTimeout(function(){if(input.length<1)return[];URL=isArticul(input)?"/ajax/search_titles_articul.php?articul="+("#"===input[0]?input.slice(1):input):$attrs.suggestUrl+"?term="+encodeURI(input),resolve($http.post(URL).then(function(response){return Array.isArray(response.data)?response.data:[response.data]}))},600)}).then(function(r){return r})},renderResult:function(result,props){result=result||[];var suggestItem,term=$(".autocomplete-input").val(),label=function(str,term){term=function(word){return word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=(word=word.replace(/q/g,"й")).replace(/w/g,"ц")).replace(/e/g,"у")).replace(/r/g,"к")).replace(/t/g,"е")).replace(/y/g,"н")).replace(/u/g,"г")).replace(/i/g,"ш")).replace(/o/g,"щ")).replace(/з/g,"з")).replace(/\[/g,"х")).replace(/\]/g,"ъ")).replace(/a/g,"ф")).replace(/s/g,"ы")).replace(/d/g,"в")).replace(/f/g,"а")).replace(/g/g,"п")).replace(/h/g,"р")).replace(/j/g,"о")).replace(/k/g,"л")).replace(/l/g,"д")).replace(/\;/g,"ж")).replace(/\'/g,"э")).replace(/z/g,"я")).replace(/x/g,"ч")).replace(/c/g,"с")).replace(/v/g,"м")).replace(/b/g,"и")).replace(/n/g,"т")).replace(/m/g,"ь")).replace(/\./g,"ю")}(term);var highlight_regex=new RegExp("("+term+")","gi");return str.replace(highlight_regex,'<span class="highlight">$1</span>')}(result.label,term);if(result.prices){if("category"!==result.type&&isArticul(term)){var priceOld=result.prices.old?'<div class="price-old"><span class="line-through">'+result.prices.old+'<span class="rub">p</span></span></div>':"",buyInfo="N"!==result.can_buy&&0!==Number(result.prices.new)?'<div class="c-box-product__counter"><div class="price">'+priceOld+'<div class="price-current"><span>'+result.prices.new+'<span class="rub">P</span></span></div></div></div><div class="c-box-product__cart"><div class="elem-product__cart"><svg aria-hidden="true" class="icon icon-basket"><use xlink:href="'+window.stp+'images/required/sprite.svg#basket"></use></svg></div></div>':"";suggestItem="<li"+props+'><a><article class="suggestion c-box-product"><div class="c-box-product__image"><img src="'+result.image+'"></div><div class="c-box-product__info"><span class="name">'+result.label+'</span><div class="articul">'+result.articul+'</div><div class="total">'+result.status_text+"</div></div>"+buyInfo+"</article></a></li>"}else suggestItem="<li"+props+"><a><article class='suggestion c-box-product c-box-product--simple'>"+label+"</article></a></li>";return suggestItem}},getResultValue:function(result){var term=$(".autocomplete-input").val();return isArticul(term)?result.articul:result.label},onSubmit:function(result){overAddToBasket?(productData={id:result.id,xml_id:result.xml_id,getout:"basket"},$scope.addItem(productData),overAddToBasket=!1):result&&window.open(encodeURI(result.url),"_self")}}),$scope.checkRequest=function(e){var requestJson=toJSON($element.serialize()),term=$(".autocomplete-input").val();"#"===term[0]&&$(".autocomplete-input").val(term.slice(1)),""==requestJson.search&&e.preventDefault()};var popupConfig={removalDelay:200,key:"pCart",items:{},type:"inline",auto:!($scope.addItem=function(frontData){$http.post("/ajax/basket/add_offer.php",frontData).then(function(response){var data;data=response.data,popupConfig.inline.markup=data,$.magnificPopup.open(popupConfig),$timeout(function(){try{myLazyLoad.update()}catch(e){}},1),$scope.loading=!1,pagePreloader(!1)},function(){$scope.loading=!1,pagePreloader(!1)})}),closeMarkup:'<button title="%title%" type="button" class="mfp-close"></button>',closeOnBgClick:!1,callbacks:{beforeOpen:function(){closePopupBtn=document.getElementsByClassName("mfp-close")[0];function preventScroll(){$("html").css({overflow:"hidden"}),$("body").hasClass("safari")?document.body.addEventListener("touchmove",preventDefaultWrapper,{passive:!1}):$("body").addClass("no-scroll")}closePopupBtn?(closePopupBtn.click(),$timeout(function(){preventScroll()},200)):preventScroll()},open:function(){var _this=this;$compile(this.content)($scope),$(this.contentContainer).children(".box-popup").append('<button title="Закрыть (Esc)" type="button" class="mfp-close"></button>'),$timeout(function(){_this.contentContainer[0].className+=" popupIn"},200)},beforeClose:function(){this.contentContainer[0].className+=" popupOut",$("html")[0].removeAttribute("style"),$("body").hasClass("safari")?document.body.removeEventListener("touchmove",preventDefaultWrapper,{passive:!1}):$("body").removeClass("no-scroll")},afterClose:function(){delete $.magnificPopup.instance.popupsCache.pCart}},inline:{markup:""}}}]),angular.module("ctrl.changeCity",[]).controller("changeCity",["$element","$scope","$http","$attrs","$rootScope","mapSrv",function($element,$scope,$http,$attrs,$rootScope,mapSrv){var URL_selected=$element.data("send-url"),inOrder=$attrs.inorder;$scope.setCity=function($event){var _this=$event.currentTarget;$(_this).parent().addClass("has-spinner"),$(".elem-radio-city input[type='radio']").prop("disabled",!0);var frontData={};frontData[$(_this).attr("name")]=$(_this).val(),URL_selected&&!inOrder&&$http.post(URL_selected,frontData).then(function(response){if(response.data.LOCATION_ID&&setTimeout(function(){location.href=location.pathname+location.search},1e3),response.data.CALLBACK){if("/basket/"===window.location.pathname||"/basket/order/"===window.location.pathname)return;return new Function(response.data.CALLBACK)()}},function(){$(_this).parent().removeClass("has-spinner"),$(".elem-radio-city input[type='radio']").prop("disabled",!1)}),URL_selected&&inOrder&&(mapSrv.pointChecked&&(mapSrv.pointID=null,mapSrv.pointInfo="",mapSrv.pointChecked=!1),$http.post(URL_selected,frontData).then(function(response){if($(_this).parent().removeClass("has-spinner"),$(".elem-radio-city input[type='radio']").prop("disabled",!1),$rootScope.$broadcast("orderMakePost",{LOCATION_NAME:response.data.LOCATION_NAME}),response.data.CALLBACK){if("/basket/"===window.location.pathname||"/basket/order/"===window.location.pathname)return;return new Function(response.data.CALLBACK)()}},function(){$(_this).parent().removeClass("has-spinner"),$(".elem-radio-city input[type='radio']").prop("disabled",!1)}))}}]),angular.module("ctrl.complectCtrl",[]).controller("complectCtrl",["$element","$scope","$timeout","$http","$compile",function($element,$scope,$timeout,$http,$compile){var anchorClicked=!1,_creditMonth=12;window.creditMonth&&0<parseInt(window.creditMonth)&&(_creditMonth=parseInt(window.creditMonth));var month_count=void 0!==_creditMonth?_creditMonth:10,allPerMonth=0;function calcPerMonth(){for(var key in $scope.complectModel)$scope.complectTotalPrice+=$scope.complectModel[key].amount*$scope.complectModel[key].price,$scope.totalItems+=$scope.complectModel[key].amount,allPerMonth+=$scope.complectModel[key].totalPerMonth;$scope.perMonth=allPerMonth,0==$scope.totalItems&&(anchorClicked=!1)}$scope.complectTotalPrice=0,$scope.totalItems=0,$timeout(function(){for(var key in $scope.complectModel={},$scope.price)$scope.complectModel[key]={},$scope.complectModel[key].price=$scope.price[key],$scope.complectModel[key].amount=$scope.amount[key],$scope.complectModel[key].perMonth=Math.ceil($scope.price[key]/month_count),$scope.complectModel[key].totalPerMonth=Math.ceil($scope.price[key]/month_count)*$scope.amount[key]},1),$scope.calcComplect=function(id){$timeout(function(){$scope.complectModel[id].amount=$scope.amount[id],$scope.complectModel[id].totalPerMonth=$scope.complectModel[id].perMonth*$scope.complectModel[id].amount,$scope.complectTotalPrice=0,allPerMonth=0,$scope.totalItems=0,calcPerMonth()},500)};var inpName,inpVal,thisID,itemsObj={};$scope.addComplect=function(url,objData){if(itemsObj={},$(".elem-number",$element).each(function(){0<(inpVal=$(this).find("input").val())&&(inpName=$(this).find("input").prop("name"),itemsObj[inpName]=inpVal)}),$('[type="hidden"]',$element).each(function(){inpName=$(this).prop("name"),inpVal=$(this).val(),itemsObj[inpName]=inpVal}),objData)for(var key in objData)itemsObj[key]=objData[key];!function(url,frontData){pagePreloader(!0),$http.post(url,frontData).then(function(response){$.magnificPopup.instance.isOpen?($.magnificPopup.close(),$timeout(function(){generatePopup(response.data)},200)):generatePopup(response.data),pagePreloader(!1)},function(){pagePreloader(!1)})}(url,toSerialize(itemsObj))},$(".box-sideinfo__anchor").click(function(){anchorClicked||($("[data-default]").each(function(){thisID=$(this).data("default"),$scope.amount[thisID]=+$('[data-product="'+thisID+'"]').data("quantity"),$scope.calcComplect(thisID)}),anchorClicked=!0)});var popupConfig={removalDelay:200,key:"pCart",items:{},type:"inline",closeMarkup:'<button title="%title%" type="button" class="mfp-close"></button>',closeOnBgClick:!1,callbacks:{beforeOpen:function(){$("body").addClass("no-scroll")},open:function(){var _this=this;$compile(this.content)($scope),$(this.contentContainer).children(".box-popup").append('<button title="Закрыть (Esc)" type="button" class="mfp-close"></button>'),$timeout(function(){_this.contentContainer[0].className+=" popupIn"},200)},beforeClose:function(){this.contentContainer[0].className+=" popupOut",$("body").removeClass("no-scroll")},afterClose:function(){delete $.magnificPopup.instance.popupsCache.pCart}},inline:{markup:""}};function generatePopup(data){popupConfig.inline.markup=data,$.magnificPopup.open(popupConfig),$timeout(function(){try{myLazyLoad.update()}catch(e){}},1)}anchorClicked=!1;$(".box-sideinfo__anchor").click(function(){anchorClicked||(calcPerMonth(),anchorClicked=!0)});var myEfficientFn=debounce(function(){$("#complectModule").isInViewport().elementTop<$("#complectModule").isInViewport().viewportBottom?$(".box-complect__informer").addClass("floating-informer"):$(".box-complect__informer").removeClass("floating-informer")},200);$(window).resize(myEfficientFn),$(window).scroll(myEfficientFn)}]),angular.module("ctrl.cartCtrl",[]).controller("cartCtrl",["$scope","$http","$element","$timeout","$compile","cartSrv",function($scope,$http,$element,$timeout,$compile,cartSrv){$scope.cartData=cartSrv;var _creditMonth=12;$scope.scrollDistance=0,window.creditMonth&&0<parseInt(window.creditMonth)&&(_creditMonth=parseInt(window.creditMonth));var closePopupBtn,month_count=void 0!==_creditMonth?_creditMonth:10;function disableScroll(){$scope.scrollDistance=$(window).scrollTop(),$("body").css({position:"fixed",left:0,top:-1*$scope.scrollDistance,bottom:0,right:0})}function enableScroll(){$("body").css({position:"",left:"",top:"",bottom:"",right:""}),$(window).scrollTop($scope.scrollDistance)}$scope.hide=!0,$scope.initCart=function(){$scope.cartData.model.totalBasketQuantity=$scope.totalBasketQuantity,$scope.cartData.model.totalBasketPrice=$scope.totalBasketPrice},$scope.initItem=function(){void 0===$.stepper?$timeout(function(){$scope.initItem()},500):$timeout(function(){$scope.hide=!1},1)},$scope.addItem=function(url,frontData,$event){void 0===$.stepper||$($element).hasClass("clicked")||($scope.loading=!0,"undefined"!=typeof pagePreloader&&pagePreloader(!0),$($element).toggleClass("clicked"),$http.post(url,frontData).then(function(response){$($element).toggleClass("clicked"),$.magnificPopup.instance.isOpen?($.magnificPopup.close(),$timeout(function(){generatePopup(response.data)},200)):generatePopup(response.data),$scope.loading=!1,pagePreloader(!1)},function(){$($element).toggleClass("clicked"),$scope.loading=!1,pagePreloader(!1),$("body").hasClass("safari")?enableScroll():$("body").removeClass("no-scroll")}))},$scope.changeByBlur=function(url,frontData){},$scope.amountChange=function(url,frontData){$scope.loading=!0;var id=frontData.id+"";+frontData.quantity>+frontData.max?frontData.quantity=+frontData.max:+frontData.quantity<1&&(frontData.quantity=1),$http.post(url,frontData).then(function(response){$scope.cartData.model.totalBasketPrice=response.data.totalBasketPrice,$scope.totalPrice[id]=response.data.totalPrice,$scope.perMonth(response.data.totalBasketPrice),$scope.freeDelivery(),$scope.loading=!1},function(){$scope.loading=!1})},$scope.removeItem=function(url,frontData,$event){$scope.loading=!0;var item=angular.element($event.currentTarget).closest("tr"),itemTable=$(item).closest("tbody");$http.post(url,frontData).then(function(response){$scope.cartData.model.totalBasketPrice=response.data.totalBasketPrice,$scope.cartData.model.totalBasketQuantity=response.data.totalBasketQuantity,$scope.perMonth($scope.cartData.model.totalBasketPrice),item.remove(),0!==itemTable.children("tr").length?$scope.freeDelivery():$scope.closeModal(),$scope.loading=!1},function(){$scope.loading=!1})},$scope.closeModal=function(){$.magnificPopup.close()},$scope.perMonth=function(totalPrice){$scope.monthPay=Math.ceil(totalPrice/month_count)};var popupConfig={removalDelay:200,key:"pCart",items:{},type:"inline",auto:!($scope.freeDelivery=function(){$http.get("/ajax/get_delivery_price.php?TYPE=BASKET&FREE=1").then(function(response){response.data.freeDeliveryMinPrice?$scope.cartData.model.freeDeliveryMinPrice=response.data.freeDeliveryMinPrice:window.freeDeliveryMinPrice&&($scope.cartData.model.freeDeliveryMinPrice=window.freeDeliveryMinPrice),response.data.arSpecial&&"Y"==response.data.arSpecial.FREE_DELIVERY_COLLECT?$scope.cartData.model.showFreeDelivery=!0:$scope.cartData.model.showFreeDelivery=!1})}),closeMarkup:'<button title="%title%" type="button" class="mfp-close"></button>',closeOnBgClick:!1,callbacks:{beforeOpen:function(){(closePopupBtn=document.getElementsByClassName("mfp-close")[0])?(closePopupBtn.click(),$timeout(function(){$("body").hasClass("safari")?disableScroll():$("body").addClass("no-scroll")},200)):$("body").hasClass("safari")?disableScroll():$("body").addClass("no-scroll")},open:function(){var _this=this;$compile(this.content)($scope),$(this.contentContainer).children(".box-popup").append('<button title="Закрыть (Esc)" type="button" class="mfp-close"></button>'),$scope.freeDelivery(),$timeout(function(){_this.contentContainer[0].className+=" popupIn"},200)},beforeClose:function(){this.contentContainer[0].className+=" popupOut",$("html")[0].removeAttribute("style"),$("body").hasClass("safari")?enableScroll():$("body").removeClass("no-scroll")},afterClose:function(){delete $.magnificPopup.instance.popupsCache.pCart}},inline:{markup:""}};function generatePopup(data){popupConfig.inline.markup=data,$.magnificPopup.open(popupConfig),$timeout(function(){try{myLazyLoad.update()}catch(e){}},1)}$scope.oneClickElement=function(id){$scope.cartData.oneClickElement=id},$("#buyOneClick_success .elem-btn").click(function(event){event.preventDefault(),document.getElementsByClassName("mfp-close")[0].click()})}]),angular.module("ctrl.addressCtrl",[]).controller("addressCtrl",["$element","$scope","$rootScope","$http","$compile","$timeout","$attrs","formSrv",function($element,$scope,$rootScope,$http,$compile,$timeout,$attrs,formSrv){$scope.formSrv=formSrv,$scope.countAddress=$element.find(".form-field").length,$scope.addressIndexes=[];for(var i=0;i<$scope.countAddress;i++)$scope.addressIndexes.push(i);var globData,clickedElem,globUrl=$attrs.url,sessid=$attrs.sessid;$scope.addressAction=function(frontData,$event){sessid=(globData=frontData).sessid,$event&&(clickedElem=angular.element($event.currentTarget)),"delete"===frontData.action?(formSrv.isEdit=!1,generatePopup('<div class="box-popup popup-password"><div class="box-popup__name">Вы хотите удалить выбранный адрес доставки?</div><div class="mt_20" style="display: flex; justify-content: space-between;"><button class="elem-btn autoDisable" data-ng-click="deleteAddress()" style="width: 45%">Да</button><button class="elem-btn elem-btn--red" style="width: 45%" data-ng-click="closeModal()">Нет</button></div></div>')):"favorite"===frontData.action?(formSrv.isEdit=!1,function(){clickedElem.hasClass("active")&&(globData.value=0);$http.post(globUrl,globData).then(function(response){if(!0===response.data.RESULT&&(clickedElem.hasClass("active")?clickedElem.removeClass("active"):($("#AddressRow").find(".form-field--icon").children("span").removeClass("active"),clickedElem.addClass("active"))),response.data.CALLBACK)return new Function(response.data.CALLBACK)()},function(){})}()):"edit"===frontData.action&&$timeout(function(){formSrv.isEdit=!0},600)};function renderAddresses(){$http.get(globUrl+"?action=getList&sessid="+sessid).then(function(response){var addresses=response.data.RESULT,allAdresses="";for(i=0;i<addresses.length;i++){var isFavoriteClass="1"==addresses[i].favorite?"active":"";allAdresses+='<div class="col-xlg-max-6 col-lg-8 col-md-12"><div class="form-field filled"><input type="text" name="homeAddress" value="'+$("#AddressRow").children().eq(i).find(".form-field__input").val()+'" class="form-field__input form-field__input--home-address" readonly><label class="form-field__label">'+$("#AddressRow").children().eq(i).find(".form-field__label").text()+"</label><div class=\"form-field--icon full\"><span data-ng-click=\"addressAction({'action': 'favorite', 'block': 'address', 'id': "+i+", 'sessid': '"+sessid+"', 'value': 1}, $event)\" class=\""+isFavoriteClass+'"><svg aria-hidden="true" class="icon icon-like"><use xlink:href="'+window.stp+'images/required/sprite.svg#like"></use></svg></span><span data-popup-get data-mfp-src="'+globUrl+"\" data-popup-data=\"{'action': 'edit', 'block': 'address', 'id': "+i+", 'sessid': '"+sessid+"'}\" data-ng-click=\"addressAction({'action': 'edit', 'block': 'address', 'id': "+i+", 'sessid': '"+sessid+'\', \'value\': 1}, $event)"><svg aria-hidden="true" class="icon icon-edit"><use xlink:href="'+window.stp+"images/required/sprite.svg#edit\"></use></svg></span><span data-ng-click=\"addressAction({'action': 'delete', 'block': 'address', 'id': "+i+", 'sessid': '"+sessid+'\'}, $event)"><svg aria-hidden="true" class="icon icon-delete"><use xlink:href="'+window.stp+'images/required/sprite.svg#delete"></use></svg></span></div></div></div>'}$("#AddressRow").empty();var compiledAddress=$compile(allAdresses)($scope);$("#AddressRow").append(compiledAddress)})}var popupResponse,newAddress,replacedRow;$scope.deleteAddress=function(){$(".autoDisable").prop("disabled")||($(".autoDisable").prop("disabled",!0),$http.post(globUrl,globData).then(function(response){if($scope.closeModal(),response.data.RESULT&&response.data.POPUP&&(popupResponse='<div class="box-popup popup-password"><div>'+response.data.MESSAGE.TEXT+"</div></div>",$timeout(function(){generatePopup(popupResponse),clickedElem.closest('div[class^="col-"]').remove();for(var i=+globData.id;i<$scope.addressIndexes.length;i++)$scope.addressIndexes[i]&&$scope.addressIndexes[i]--;$scope.addressIndexes.splice(globData.id,1),renderAddresses()},200)),response.data.CALLBACK)return new Function(response.data.CALLBACK)()},function(){}))},$scope.$watch("formSrv.data",function(newValue,oldValue){!formSrv.isEdit&&newValue.DATA&&newValue.DATA.SHOW?function(){$scope.addressIndexes.length?$scope.addressIndexes.push(+$scope.addressIndexes.slice(-1)+1):$scope.addressIndexes.push(0);var address=$scope.formSrv.data.DATA.SHOW,id=$scope.addressIndexes.length-1,type=$scope.formSrv.data.DATA.type;newAddress='<div class="col-xlg-max-6 col-lg-8 col-md-12"><div class="form-field filled"><input type="text" name="homeAddress" value="'+address+'" class="form-field__input form-field__input--home-address" readonly><label class="form-field__label">'+type+"</label><div class=\"form-field--icon full\"><span data-ng-click=\"addressAction({'action': 'favorite', 'block': 'address', 'id': "+id+", 'sessid': '"+sessid+'\', \'value\': 1}, $event)"><svg aria-hidden="true" class="icon icon-like"><use xlink:href="'+window.stp+'images/required/sprite.svg#like"></use></svg></span><span data-popup-get data-mfp-src="'+globUrl+"\" data-popup-data=\"{'action': 'edit', 'block': 'address', 'id': "+id+", 'sessid': '"+sessid+"'}\" data-ng-click=\"addressAction({'action': 'edit', 'block': 'address', 'id': "+id+", 'sessid': '"+sessid+'\', \'value\': 1}, $event)"><svg aria-hidden="true" class="icon icon-edit"><use xlink:href="'+window.stp+"images/required/sprite.svg#edit\"></use></svg></span><span data-ng-click=\"addressAction({'action': 'delete', 'block': 'address', 'id': "+id+", 'sessid': '"+sessid+'\'}, $event)"><svg aria-hidden="true" class="icon icon-delete"><use xlink:href="'+window.stp+'images/required/sprite.svg#delete"></use></svg></span></div></div></div>';var compiledAddress=$compile(newAddress)($scope);$("#AddressRow").append(compiledAddress)}():formSrv.isEdit&&newValue.DATA&&newValue.DATA.SHOW&&function(){replacedRow=clickedElem.closest('div[class^="col-"]');var address=$scope.formSrv.data.DATA.SHOW,id=replacedRow.index(),type=$scope.formSrv.data.DATA.type,isFavoriteClass=clickedElem.prev("span").hasClass("active")?"active":"";newAddress='<div class="form-field filled"><input type="text" name="homeAddress" value="'+address+'" class="form-field__input form-field__input--home-address" readonly><label class="form-field__label">'+type+"</label><div class=\"form-field--icon full\"><span data-ng-click=\"addressAction({'action': 'favorite', 'block': 'address', 'id': "+id+", 'sessid': '"+sessid+"', 'value': 1}, $event)\" class=\""+isFavoriteClass+'"><svg aria-hidden="true" class="icon icon-like"><use xlink:href="'+window.stp+'images/required/sprite.svg#like"></use></svg></span><span data-popup-get data-mfp-src="'+globUrl+"\" data-popup-data=\"{'action': 'edit', 'block': 'address', 'id': "+id+", 'sessid': '"+sessid+"'}\" data-ng-click=\"addressAction({'action': 'edit', 'block': 'address', 'id': "+id+", 'sessid': '"+sessid+'\', \'value\': 1}, $event)"><svg aria-hidden="true" class="icon icon-edit"><use xlink:href="'+window.stp+"images/required/sprite.svg#edit\"></use></svg></span><span data-ng-click=\"addressAction({'action': 'delete', 'block': 'address', 'id': "+id+", 'sessid': '"+sessid+'\'}, $event)"><svg aria-hidden="true" class="icon icon-delete"><use xlink:href="'+window.stp+'images/required/sprite.svg#delete"></use></svg></span></div></div>',replacedRow.empty();var compiledAddress=$compile(newAddress)($scope);replacedRow.append(compiledAddress)}()});var popupConfig={removalDelay:200,key:"pAddress",items:{},type:"inline",closeMarkup:'<button title="%title%" type="button" class="mfp-close"></button>',closeOnBgClick:!($scope.closeModal=function(){$.magnificPopup.close()}),callbacks:{beforeOpen:function(){$("body").addClass("no-scroll")},open:function(){var _this=this;$compile(this.content)($scope),$(this.contentContainer).children(".box-popup").append('<button title="Закрыть (Esc)" type="button" class="mfp-close"></button>'),$timeout(function(){_this.contentContainer[0].className+=" popupIn"},200)},beforeClose:function(){this.contentContainer[0].className+=" popupOut",$("body").removeClass("no-scroll")},afterClose:function(){delete $.magnificPopup.instance.popupsCache.pAddress}},inline:{markup:""}};function generatePopup(data){popupConfig.inline.markup=data,$.magnificPopup.open(popupConfig)}}]),angular.module("ctrl.basketCtrl",[]).controller("basketCtrl",["$element","$scope","$http","$attrs","$compile","$timeout","cartSrv",function($element,$scope,$http,$attrs,$compile,$timeout,cartSrv){var _creditMonth=12;window.creditMonth&&0<parseInt(window.creditMonth)&&(_creditMonth=parseInt(window.creditMonth));var month_count=void 0!==_creditMonth?_creditMonth:10;$element.on("keydown",".form-control--cart",function(e){if("."==e.key)return!1}),$timeout(function(){$scope.perMonth=Math.ceil($scope.totalSum/month_count)},1);var url=$attrs.action,frontData,cantBuy=!1,clickedElement,returnedForm,productsInCart;if(0<$attrs.naAvailable&&(cantBuy=!0),$attrs.callback)try{eval($attrs.callback)}catch(err){console.warn(err)}$scope.pvzSelected=!1,$scope.makePost=function($event,elemData){if($scope.pvzSelected=35===$scope.deliveryId,$event&&angular.element($event.currentTarget).parent(".form-field").children(".form-field__input")&&angular.element($event.currentTarget).parent(".form-field").children(".form-field__input").val()&&0==angular.element($event.currentTarget).parent(".form-field").children(".form-field__input").val().length)return angular.element($event.currentTarget).parent(".form-field").addClass("has-error"),!1;$scope.loading=!0,$timeout(function(){frontData="object"===(void 0===elemData?"undefined":_typeof(elemData))&&null!==elemData?toSerialize(elemData)+"&"+$element.serialize():$element.serialize(),$http.post(url,frontData).then(function(response){returnedForm=$.parseHTML($.trim(response.data),document,!0),$scope.$destroy()},function(){$scope.loading=!1})},100)},$scope.validateEmail=function($event,url){var data=$event.currentTarget.value;angular.isDefined($scope.order_email)&&($scope.order_email=data),""===data||angular.element($event.currentTarget).parent().hasClass("has-error")||($scope.loading=!0,$http.post(url,angular.element.param({email:data})).then(function(response){$scope.loading=!1,"success"===response.data.message?angular.element($event.currentTarget).parent().hasClass("has-error")&&angular.element($event.currentTarget).parent().removeClass("has-error"):"error"===response.data.message&&angular.element($event.currentTarget).parent().addClass("has-error")},function(){$scope.loading=!1}))},$scope.$on("callMakePost",function(event,args){$(".elem-city__current").text(args.LOCATION_NAME),$scope.makePost()}),$scope.$on("$destroy",function(){$element.remove(),$(returnedForm).insertAfter(".elem-header--styler"),$timeout(function(){var scope=angular.element(".box-cart").scope();void 0!==scope?(productsInCart=angular.element(".box-cart").find(".elem-table--full").find("[data-product-id]").length,cartSrv.model.totalBasketQuantity=productsInCart,$compile($(".box-cart"))(scope)):cartSrv.model.totalBasketQuantity=0},50),$scope.loading=!1,$timeout(function(){$(".selectpicker").selectpicker("refresh");try{myLazyLoad.update()}catch(e){}},100)}),$element.validate({errorElement:"div",submitHandler:function(form){if($('[name="confirmorder"]').length<1&&$("<input />").attr("type","hidden").attr("name","confirmorder").attr("value","Y").appendTo($element),35===$scope.deliveryId&&!$("#pvz_description").text().length)return $("#pvzerror").length||$("<span>").attr("id","pvzerror").addClass("form-field__error-total").text("Необходимо выбрать пункт выдачи заказа").prependTo($element.find("#mapPvzNew")),$("html, body").animate({scrollTop:$("#pvzerror").offset().top-20},500),$('[name="confirmorder"]').attr("value","N"),!1;if(cantBuy)return $("html, body").animate({scrollTop:$(".elem-header__title").offset().top},500),dataLayer.push({event:"OWOX_Forms",timingCategory:"Forms",timingVar:"send",timingValue:window.submitTime-window.firstInputTimestamp,timingLabel:"unsuccessful",eventContent:$attrs.id,eventLocation:null,eventContext:"notAllAvailable",eventPosition:window.orderFormSubmitAttempts?window.orderFormSubmitAttempts:"0"}),$('[name="confirmorder"]').attr("value","N"),!1;if(0<$("input[data-mask-input='+7 (999) 999-99-99']:required",$element).length){for(var telItem=$("input[data-mask-input='+7 (999) 999-99-99']",$element),telItemVal=telItem.val(),phoneError=!1,i=0;i<telItemVal.length;i++)if("_"==telItemVal[i]){phoneError=!0;break}return phoneError?(telItem.parent().addClass("has-error"),$("html, body").animate({scrollTop:telItem.offset().top-100},200),$('[name="confirmorder"]').attr("value","N"),!1):($('[name="confirmorder"]').attr("value","Y"),orderFormSubmit(),pagePreloader(!0),!0)}return $('[name="confirmorder"]').attr("value","Y"),pagePreloader(!0),!0},invalidHandler:function(event,validator){if(validator.numberOfInvalids()){dataLayer.push({event:"OWOX_Forms",timingCategory:"Forms",timingVar:"send",timingValue:window.submitTime-window.firstInputTimestamp,timingLabel:"unsuccessful",eventContent:$attrs.id,eventLocation:null,eventContext:!1,eventPosition:window.orderFormSubmitAttempts?window.orderFormSubmitAttempts:"0"});var shaObj=new jsSHA("SHA-256","TEXT");shaObj.update($(".email-input",$element).val());var email_hash=shaObj.getHash("B64"),shaObj2=new jsSHA("SHA-256","TEXT");shaObj2.update($(".phone-input",$element).val());var phone_hash=shaObj2.getHash("B64");dataLayer.push({event:"OWOX",eventCategory:"Conversions",eventAction:"click",eventLabel:"makeOrder",eventContent:null,eventContext:"unsuccessful",eventPosition:null,eventLocation:null,eventCategoryGroupName:null,eventCategoryName:null,eventCategoryId:null,eventProductName:null,eventProductPrice:null,userEmailHash:email_hash||null,userPhonelHash:phone_hash||null,ecommerce:{checkout:{actionField:{step:"2",option:"Оформление"},products:[window.checkoutProducts]}}})}},errorPlacement:function(error,element){$(element).parent().addClass("has-error")},highlight:function(element,errorClass){$(element).parent().removeClass("has-error")},unhighlight:function(element,errorClass,validClass){$(element).parent().removeClass("has-error")}}),$element.on("keyup keypress",function(e){if(13===(e.keyCode||e.which))return e.preventDefault(),!1});var popupConfig={removalDelay:200,key:"pBasket",items:{},type:"inline",closeMarkup:'<button title="%title%" type="button" class="mfp-close"></button>',closeOnBgClick:!1,callbacks:{beforeOpen:function(){$("body").addClass("no-scroll")},open:function(){var _this=this;$timeout(function(){_this.contentContainer[0].className+=" popupIn"},200)},beforeClose:function(){this.contentContainer[0].className+=" popupOut",$("body").removeClass("no-scroll")},afterClose:function(){delete $.magnificPopup.instance.popupsCache.pBasket}},inline:{markup:""}},cardModel,cardVal,allCards;function generatePopup(data){data.TITLE&&""!=data.TITLE?popupConfig.inline.markup='<div class="box-popup popup-password"><button title="Закрыть (Esc)" type="button" class="mfp-close"></button><div class="box-popup__name">'+data.TITLE+"</div><br><div>"+data.TEXT+"</div></div>":popupConfig.inline.markup='<div class="box-popup popup-password"><button title="Закрыть (Esc)" type="button" class="mfp-close"></button><div>'+data.TEXT+"</div></div>",$.magnificPopup.open(popupConfig)}$scope.calcTotal=function(cardNum,val){$timeout(function(){$('[data-card-num="'+cardNum+'"]').hasClass("card-confirmed")&&$('[data-card-num="'+cardNum+'"]').hasClass("active")&&!$('[data-card-num="'+cardNum+'"]').hasClass("elem-card--disabled")&&($scope.modelByBalance=val,addBonusRequest(cardNum,val))},1)},$(document).off("click",".js-card"),$(document).on("click",".js-card",function(){var _this=this;$timeout(function(){!$(_this).hasClass("card-confirmed")||$(_this).hasClass("elem-card--disabled")||$(_this).hasClass("active")?!$(_this).hasClass("elem-card--disabled")&&($(_this).hasClass("card-confirmed")||$(_this).hasClass("active"))||(addBonusRequest($(_this).data("cardNum"),0),$scope.modelByBalance=0):(cardModel=$(_this).find("[data-slider]").data("ngModel"),cardVal=parseInt($(_this).find(".range-field").children("input").val()),$scope.modelByBalance=cardVal,addBonusRequest($(_this).data("cardNum"),cardVal))},1),setTimeout(function(){(allCards=$(_this).parents(".row").find(".elem-card")).removeClass("active"),allCards.each(function(){$(this).find(".range-field").length&&($(this).find(".range-field").children("input.form-control")[0].disabled=!0)}),!$(_this).hasClass("elem-card--disabled")&&$(_this).find(".range-field").children("input.form-control").length&&($(_this).find(".range-field").children("input.form-control")[0].disabled=!1,window.activeBalanceCardInCart=$(_this).data("cardNum")),$(_this).hasClass("elem-card--checkbox")||($(".elem-card--checkbox").find(".elem-card__link").children('[type="checkbox"]').prop("checked",!1),$(".elem-card--checkbox").find(".elem-card__info").find('[type="checkbox"]').prop("checked",!1),$(".elem-card--checkbox").find(".elem-card__info").find('[name="ORDER_PROP_63"]').val("")),$(_this).hasClass("elem-card--checkbox")&&($(_this).find(".elem-card__link").children('[type="checkbox"]').prop("checked",!0),$(_this).find(".elem-card__info").find('[type="checkbox"]').prop("checked",!0),$(_this).find(".elem-card__info").find('[name="ORDER_PROP_63"]').val("1")),$(_this).data("cardNum")?$('[name="ORDER_PROP_41"]').val($(_this).data("cardNum")):$('[name="ORDER_PROP_41"]').val(""),$(_this).find(".js-elem-card__link--add").length&&!$(_this).hasClass("open")&&$(_this).find(".js-elem-card__link--add").trigger("click"),$(_this).addClass("active")},10)}),$scope.$on("updateTotal",function(event,data){$timeout(function(){$scope.modelByBalance=data},2)}),$('[type="submit"]',$element).click(function(){!1!==window.firstTimeSubmit&&(void 0===window.firstInputTimestamp&&(window.firstInputTimestamp=window.submitTime),dataLayer.push({event:"OWOX_Forms",timingCategory:"Forms",timingVar:"send",timingValue:window.submitTime-window.firstInputTimestamp,timingLabel:"first",eventContent:$attrs.id,eventLocation:window.firstActiveInput,eventPosition:null}),window.firstTimeSubmit=!1)});var bonusData={PRODUCTS:{},CARD:{}},prodID;function addBonusRequest(cardNum,val){bonusData={PRODUCTS:{},CARD:{}},$("[data-product-id]").each(function(){prodID=parseInt($(this).data("productId")),bonusData.PRODUCTS[prodID]={},bonusData.PRODUCTS[prodID].QUANTITY=parseInt($(this).find(".stepper").children("input").val()),bonusData.PRODUCTS[prodID].PRICE=parseInt($(this).data("price"))}),bonusData.CARD.NUM=parseInt(cardNum),bonusData.CARD.TAKE_BONUS=parseInt(val),$http.post("/ajax/basket/recalc_bonus.php",bonusData).then(function(response){response.data.OUT&&($(".elem-card__status").children(".color-yellow").text(response.data.OUT),$(".bonus-plus").children(".color-yellow").text(response.data.OUT))},function(){})}$scope.checkPromoCodes=function(){(0<$scope.promocodeNumber.length||0<$scope.couponNumber.length)&&$scope.makePost()}}]),angular.module("ctrl.confirmEmail",[]).controller("confirmEmail",["$element","$scope","$http","$timeout","$attrs",function($element,$scope,$http,$timeout,$attrs){var url,frontData;$scope.sendData=function(){url=$attrs.action,frontData=$(":input",$element).serialize(),!$element.children("form-field").hasClass("has-error")&&0<$element.find("#myEmail").val().length?$http.post(url,frontData).then(function(response){if(response.data.MESSAGE&&response.data.POPUP&&function(data){data.TITLE&&""!=data.TITLE?popupConfig.inline.markup='<div class="box-popup popup-password"><button title="Закрыть (Esc)" type="button" class="mfp-close"></button><div class="box-popup__name">'+data.TITLE+"</div><br><div>"+data.TEXT+"</div></div>":popupConfig.inline.markup='<div class="box-popup popup-password"><button title="Закрыть (Esc)" type="button" class="mfp-close"></button><div>'+data.TEXT+"</div></div>";$.magnificPopup.open(popupConfig)}(response.data.MESSAGE),!0===response.data.RESULT&&$("#dynamicAlert").text("Необходимо подтвердить электронную почту"),response.data.CALLBACK)return new Function(response.data.CALLBACK)()},function(){}):($element.children("form-field").addClass("has-error"),$element.find("#myEmail").focus())},$("#myEmail").on("keyup",function(){0<$(this).val().length?$(this).parent(".form-field").removeClass("has-error"):$(this).parent(".form-field").addClass("has-error")});var popupConfig={removalDelay:200,key:"pAnswer",items:{},type:"inline",closeMarkup:'<button title="%title%" type="button" class="mfp-close"></button>',closeOnBgClick:!1,callbacks:{beforeOpen:function(){$("body").addClass("no-scroll")},open:function(){var _this=this;$timeout(function(){_this.contentContainer[0].className+=" popupIn"},200)},beforeClose:function(){this.contentContainer[0].className+=" popupOut",$("body").removeClass("no-scroll")},afterClose:function(){delete $.magnificPopup.instance.popupsCache.pAnswer}},inline:{markup:""}}}]),angular.module("ctrl.smsCtrl",[]).controller("smsCtrl",["$element","$scope","$http","$attrs","$timeout","$compile","formSrv","favSrv",function($element,$scope,$http,$attrs,$timeout,$compile,formSrv,favSrv){var url=$attrs.action;$scope.smsWaiting=!1,$scope.hasMessage=!1,$scope.cardTrue=!1,$scope.cardFalse=!1,$scope.timeElapsed=!1,$scope.resend=!1;function btnStateDisabled(val){for(var btns=document.querySelectorAll('form[data-recaptcha-elem] button[type="submit"]'),i=0;btns.length>i;i++)val?btns[i].classList.add("disabled"):btns[i].classList.remove("disabled")}var captchaOpt;if($attrs.recaptchaElem&&""!=window.captchaKey){$element.addClass("has-loader"),btnStateDisabled(!0),$element.append('<div id="'+$attrs.recaptchaElem+'" />');var attempt=1;setTimeout(function run(){30!=attempt&&("object"==typeof grecaptcha&&"function"==typeof grecaptcha.render&&document.getElementById($attrs.recaptchaElem)?(captchaOpt=grecaptcha.render($attrs.recaptchaElem,{sitekey:window.captchaKey,callback:captchaSubmit,size:"invisible"}),$element.removeClass("has-loader"),$(".box-popup *").css("pointer-events","").prop("readonly",!1),$(".box-popup input").prop("disabled",""),btnStateDisabled(!1),attempt=30):(attempt++,setTimeout(run,1e3)))},1e3),$timeout(function(){var isCaptchaVisible=!1;$('iframe[title*="recaptcha"]').each(function(i,el){"visible"===$(el).parent().parent().css("visibility")&&(isCaptchaVisible=!0)}),isCaptchaVisible||($element.removeClass("has-loader"),$(".box-popup *").css("pointer-events","").prop("readonly",!1),$(".box-popup input").prop("disabled",""),btnStateDisabled(!1))},3e4)}var tempFavIds,timer,captchaSubmit=function(){cardRequest()};$timeout(function(){tempFavIds=favSrv.ids,$scope.fav_ids=tempFavIds.join()},10),$element.on("keypress",'.phone-confirm-input, input[name="code"]',function(e){13===(e.keyCode||e.which)&&$(this).parent().find(".elem-btn").click()}),$element.on("keyup keypress",function(e){if(13===(e.keyCode||e.which))return e.preventDefault(),!1});function checkIfCaptcha(){var isCaptchaVisible=!1,count=0,timer=setInterval(function(){$('iframe[title*="recaptcha"]').each(function(i,el){"visible"===$(el).parent().parent().css("visibility")&&(isCaptchaVisible=!0)}),isCaptchaVisible?($element.removeClass("has-loader"),$(document).on("click",function(e){$(e.target).next().children('iframe[title*="recaptcha"]')&&($(".box-popup *").css("pointer-events","").prop("readonly",!1),$(".box-popup input").prop("disabled",""),btnStateDisabled(!1),$('iframe[title*="recaptcha"]').each(function(i,el){$(el).parent().parent().css("visibility","hidden")}))}),clearTimeout(timer),function(){var timer=setInterval(function(){0;var isCaptchaVisible=!1;$('iframe[title*="recaptcha"]').each(function(i,el){"visible"===$(el).parent().parent().css("visibility")&&(isCaptchaVisible=!0)}),isCaptchaVisible||($element.removeClass("has-loader"),$(".box-popup *").css("pointer-events","").prop("readonly",!1),$(".box-popup input").prop("disabled",""),btnStateDisabled(!1),clearInterval(timer))},200)}()):count++,50<count&&clearTimeout(timer)},100)}var cardNumber,codeNumber,lastCodeNumber;function cardRequest(){$(".box-popup input").prop("disabled",""),$(".box-popup *").css("pointer-events","").prop("readonly",!1),$timeout.cancel(timer),$http.post(url,$element.serialize()).then(function(response){if("OK"!=response.data.STATUS&&"ALREADY_SENT"!=response.data.STATUS||($scope.smsWaiting=!0,$scope.cardTrue=!0,$scope.cardFalse=!1),response.data.MESSAGE&&($scope.infoText=response.data.MESSAGE,$scope.hasMessage=!0),"ERROR"==response.data.STATUS&&2!=response.data.ERROR_TYPE&&($scope.cardTrue=!1,$scope.cardFalse=!0,$scope.smsWaiting=!1,$scope.timeElapsed=!1),"ERROR"==response.data.STATUS&&2==response.data.ERROR_TYPE&&($scope.cardTrue=!1,$scope.cardFalse=!1,$scope.smsWaiting=!0,$scope.timeElapsed=!1),0<response.data.REMAIN_TIME&&($scope.timeElapsed=!1,$timeout(function(){startTimer(response.data.REMAIN_TIME,$(".mess-sms-timer")),sendAgainTimer(response.data.REMAIN_TIME+2)},0)),response.data.REDIRECT_URL&&response.data.STATUS&&"AUTH_OK"==response.data.STATUS&&(location.href=response.data.REDIRECT_URL),$element.removeClass("has-loader"),btnStateDisabled(!1),"AUTH_OK"==response.data.STATUS&&($(".box-search").empty(),$(".mobile-cabinet-cart").empty(),angular.element(".box-search").append($compile(response.data.HEADER_DESKTOP)($scope)),angular.element(".mobile-cabinet-cart").append($compile(response.data.HEADER_MOBILE)($scope)),favSrv.ids=response.data.FAV_IDS,window.is_authorized=!0,localStorage.removeItem("favObj"),$(".opt-favorite").removeClass("active"),$timeout(function(){for(var i=0;i<favSrv.ids.length;i++)$('[data-ng-init="checkFav('+favSrv.ids[i]+')"]').addClass("active")},200),$.magnificPopup.close()),response.data.CALLBACK)return new Function(response.data.CALLBACK)()},function(){}),$scope.resend=!1}function sendAgainTimer(time){timer=$timeout(function(){$scope.timeElapsed=!0,$scope.infoText="НЕ ПОЛУЧИЛИ КОД? НАЖМИТЕ ДЛЯ ПОВТОРНОЙ ОТПРАВКИ КОДА"},1e3*time)}$scope.checkCard=function($event){$event.preventDefault(),"_"!=(cardNumber=$($event.currentTarget).hasClass("elem-btn")?$('[name="CARD_NUMBER"]').val():$($event.currentTarget).val()).substr(cardNumber.length-1)&&cardNumber.length?($($event.currentTarget).closest(".elem-sms-auth").children(".form-field").removeClass("has-error"),$scope.resend=!0,$element.addClass("has-loader"),$timeout(function(){btnStateDisabled(!0),$(".box-popup *").css("pointer-events","none").prop("readonly",!0),$(".box-popup input").prop("disabled","disabled")},200),$timeout(function(){$attrs.recaptchaElem&&""!=window.captchaKey&&"object"==typeof grecaptcha&&"function"==typeof grecaptcha.execute?(grecaptcha.reset(captchaOpt),grecaptcha.execute(captchaOpt).then(function(){listenRecaptchaClose($element),checkIfCaptcha()})):cardRequest()},0),cardNumber):$($event.currentTarget).hasClass("elem-btn")&&$($event.currentTarget).closest(".elem-sms-auth").children(".form-field").addClass("has-error")},$scope.checkSms=function($event){(codeNumber=$($event.currentTarget).hasClass("elem-btn")?$('[name="SMS_CODE"]').val():$($event.currentTarget).val())&&"_"!=codeNumber.substr(codeNumber.length-1)&&codeNumber!=lastCodeNumber&&($element.addClass("has-loader"),btnStateDisabled(!0),$(".box-popup *").css("pointer-events","none").prop("readonly",!0),$(".box-popup input").prop("disabled","disabled"),$attrs.recaptchaElem&&""!=window.captchaKey&&"object"==typeof grecaptcha&&"function"==typeof grecaptcha.execute?(grecaptcha.reset(captchaOpt),grecaptcha.execute(captchaOpt).then(function(){listenRecaptchaClose($element),checkIfCaptcha()})):cardRequest(),lastCodeNumber=codeNumber)},$scope.sendAgain=function($event){$($event.currentTarget).hasClass("pseudolink")&&($scope.resend=!0,$timeout(function(){cardRequest()},0))},$scope.type={yes:!1,no:!1},$scope.isBind=function(flag){$element.addClass("has-loader"),btnStateDisabled(!0),flag?($scope.type.yes=!0,$scope.type.no=!1):($scope.type.yes=!1,$scope.type.no=!0),$timeout(function(){$attrs.recaptchaElem&&""!=window.captchaKey&&"object"==typeof grecaptcha&&"function"==typeof grecaptcha.execute?(grecaptcha.reset(captchaOpt),grecaptcha.execute(captchaOpt).then(function(){listenRecaptchaClose($element)})):cardRequest()},0)},formSrv.phoneConfirmed=!1;var frontData,confirmedNumber="";$scope.blockSmsBtn=!1,$scope.phoneError=!1;var popupConfig={removalDelay:200,key:"pAnswer",items:{},type:"inline",closeMarkup:'<button title="%title%" type="button" class="mfp-close"></button>',closeOnBgClick:!($scope.confirmNumber=function(url,data){$(".box-popup input").prop("disabled",""),$scope.phoneError=!1,frontData=$(":input",$element).serialize()+"&"+toSerialize(data),$timeout.cancel(timer),""!=(confirmedNumber=$element.find(".phone-confirm-input")).val()&&confirmedNumber.val()!=confirmedNumber.attr("data-placeholder")||confirmedNumber.parent().addClass("has-error"),$http.post(url,frontData).then(function(response){"send"==response.data.status&&($scope.timeElapsed=!1,$scope.infoText=response.data.message,$timeout(function(){startTimer(response.data.REMAIN_TIME,".send-counter"),sendAgainTimer(response.data.REMAIN_TIME+2)},0)),"wrongCode"==response.data.status&&($scope.timeElapsed=!1,$scope.infoText=response.data.message,response.data.REMAIN_TIME&&startTimer(response.data.REMAIN_TIME,".send-counter")),"already_send"==response.data.status&&($scope.timeElapsed=!1,$scope.infoText=response.data.message,$timeout(function(){startTimer(response.data.REMAIN_TIME,".send-counter"),sendAgainTimer(response.data.REMAIN_TIME+2),document.querySelector('input[name="code"]')&&(angular.element(document.querySelector('input[name="code"]')).focus(),angular.element(document.querySelector('input[name="code"]')).get(0).setSelectionRange(0,0))},0)),"maxAttemptsExceed"==response.data.status&&($scope.timeElapsed=!1,$scope.blockSmsBtn=!0,$scope.infoText=response.data.message,timer=$timeout(function(){$scope.timeElapsed=!0,$scope.blockSmsBtn=!1},3e3)),"success"==response.data.status&&($scope.timeElapsed=!0,$scope.phoneConfirmed=!0,$scope.smsConfirmed=!0,formSrv.phoneConfirmed=!0,confirmedNumber=$element.find(".phone-confirm-input").val()),"error"===response.data.status&&($scope.phoneError=!0,response.data.MESSAGE&&!response.data.POPUP?response.data.MESSAGE.TITLE&&response.data.MESSAGE.TEXT?$(".form-field__error-phone",$element).html('<br><div class="form-field__error-title">'+response.data.MESSAGE.TITLE+'</div><p class="form-field__error-text">'+response.data.MESSAGE.TEXT+"</p>"):response.data.MESSAGE.TITLE?$(".form-field__error-phone",$element).html('<div class="form-field__error-title">'+response.data.MESSAGE.TITLE+"</div>"):response.data.MESSAGE.TEXT&&$(".form-field__error-phone",$element).html('<p class="form-field__error-text">'+response.data.MESSAGE.TEXT+"</p>"):response.data.MESSAGE&&response.data.POPUP?$.magnificPopup.instance.isOpen?($timeout(function(){$.magnificPopup.close()},100),$timeout(function(){generatePopup(response.data.MESSAGE)},500)):generatePopup(response.data.MESSAGE):$(".form-field__error-phone",$element).html("")),document.querySelector('[name="sessid"]')&&$http({method:"POST",url:"/ajax/get_sessid.php"}).then(function(response){$('[name="sessid"]').val(response.data)})},function(){})}),callbacks:{beforeOpen:function(){$("body").addClass("no-scroll")},open:function(){var _this=this;window.backendGetForm=!1,$timeout(function(){_this.contentContainer[0].className+=" popupIn"},200)},beforeClose:function(){this.contentContainer[0].className+=" popupOut",$("body").removeClass("no-scroll")},afterClose:function(){delete $.magnificPopup.instance.popupsCache.pAnswer}},inline:{markup:""}};function generatePopup(data){data.TITLE&&""!=data.TITLE?popupConfig.inline.markup='<div class="box-popup popup-password"><button title="Закрыть (Esc)" type="button" class="mfp-close"></button><div class="box-popup__name">'+data.TITLE+"</div><br><div>"+data.TEXT+"</div></div>":popupConfig.inline.markup='<div class="box-popup popup-password"><button title="Закрыть (Esc)" type="button" class="mfp-close"></button><div>'+data.TEXT+"</div></div>",$.magnificPopup.open(popupConfig)}var phoneNumber=$element.find(".phone-confirm-input").val();$scope.phoneFilled=phoneNumber&&phoneNumber.indexOf("_")<0,$scope.reconfirm=function($event){13!==($event.keyCode||$event.which)||$scope.phoneConfirmed||$timeout(function(){$($event.currentTarget).parent().find(".elem-btn").click()},0),"_"!=(phoneNumber=$($event.currentTarget).val()).substr(phoneNumber.length-1)&&(confirmedNumber!=phoneNumber?($scope.phoneConfirmed=!1,formSrv.phoneConfirmed=!1):""!=phoneNumber&&confirmedNumber==phoneNumber&&($scope.phoneConfirmed=!0,formSrv.phoneConfirmed=!0)),$scope.phoneFilled=phoneNumber&&phoneNumber.indexOf("_")<0}}]),angular.module("ctrl.cardCtrl",[]).controller("cardCtrl",["$element","$scope","$http","$attrs","$timeout","$compile","formSrv",function($element,$scope,$http,$attrs,$timeout,$compile,formSrv){var frontData,timer,inputElem,cardNumber,codeNumber,lastCodeNumber,justAdded,clickedElement,url=$attrs.action;function cardRequest(){$timeout.cancel(timer),frontData=$element.serialize(),toJSON(frontData),$timeout.cancel(timer),$scope.isLoadind=!0,inputElem.blur(),$http.post(url,frontData).then(function(response){var cardNum,cardBalance,cardNeedRegister;if($scope.needRegister=!1,"ERROR"==response.data.RESULT&&($scope.hasError=!0),response.data.MESSAGE&&($scope.errorText=response.data.MESSAGE,40<$scope.errorText.length?$element.addClass("big-error"):$element.removeClass("big-error")),"OK"==response.data.RESULT&&($scope.hasError=!1,$scope.cardNotAdded=!1,$scope.cardAdded=!0,$timeout(function(){document.querySelector('input[name="smscode"]')&&(angular.element(document.querySelector('input[name="smscode"]')).focus(),angular.element(document.querySelector('input[name="smscode"]')).get(0).setSelectionRange(0,0))},10)),response.data.REMAIN_TIME&&response.data.MESSAGE_TEXT&&($scope.timeRemainText=response.data.MESSAGE_TEXT,$element.removeClass("big-error")),0<response.data.REMAIN_TIME&&($scope.timeElapsed=!1,$timeout(function(){var time;startTimer(response.data.REMAIN_TIME,$(".timer-error")),time=response.data.REMAIN_TIME+2,timer=$timeout(function(){$scope.timeElapsed=!0},1e3*time)},0)),"MAX_SMS_ATTEMPTS"==response.data.ERROR&&($scope.cardNotAdded=!1,$scope.cardAdded=!0,$scope.hasError=!1,$scope.timeRemainText=response.data.MESSAGE_TEXT),"NEED_REGISTER"==response.data.RESULT&&($scope.timeElapsed=!0,$scope.cardNotAdded=!0,$scope.cardAdded=!1,$scope.timeRemainText=response.data.MESSAGE,$scope.card.BALANCE=response.data.CARD.BALANCE,$scope.card.NUMBER=response.data.CARD.NUMBER,cardNum=response.data.CARD.NUMBER,cardBalance=response.data.CARD.BALANCE_TEXT,cardNeedRegister='<div class="col-xlg-max-4 col-xlg-5 col-lg-6 col-md-8 col-sm-8 col-xs-12 row-line-col"><div class="elem-card elem-card--cart js-card"><div class="elem-card__num">№ '+cardNum+'</div><div class="elem-card__in"><div class="elem-card__bonus">'+cardBalance+'</div><div class="elem-card__date text-left js-elem-btn underline" data-popup-inline data-mfp-src="#popup_Bonus" ng-click="globalCardNum(\''+cardNum+'\')">Для списания бонусов с этой карты необходимо <br>зарегистрировать анкету участника Hoff бонус</div></div><div class="elem-card__in--info"><div class="elem-card__close js-elem-card-close"><svg aria-hidden="true" class="icon icon-clear"><use xlink:href="'+window.stp+'images/required/sprite.svg#clear"></use></svg></div><div class="elem-card__info text-center" style="display: block; height: auto;">Для списания бонусов с этой карты необходимо зарегистрировать анкету участника Hoff бонус. <br>Заполните <a href="/bonus/registration/" target="_blank">анкету на сайте</a> или обратитесь в магазин Hoff на стойку сервиса. Через 2 дня, после регистрации, вы сможете использовать доступные для списания бонусы.</div></div></div></div>',$element.parent().before(cardNeedRegister),justAdded=$element.parent().prev(".row-line-col").children(".elem-card"),$timeout(function(){$compile(justAdded.contents())($scope)},0),$element.removeClass("open"),$('[name="bcnumber"]',$element).val(""),$scope.show_inlinePopup("#popup_Bonus"),$scope.globalCardNum(response.data.CARD.NUMBER)),"OK"==response.data.RESULT&&response.data.CARD&&($scope.timeElapsed=!0,$scope.hasError=!1,$scope.cardNotAdded=!0,$scope.cardAdded=!1,$scope.card.BALANCE=response.data.CARD.BALANCE,$scope.card.BALANCE_ACTIVE=response.data.CARD.BALANCE_ACTIVE_TEXT,$scope.card.NUMBER=response.data.CARD.NUMBER,$scope.card.WITHDRAWAL_COUNT=response.data.CARD.WITHDRAWAL_COUNT_TEXT,$scope.card.WITHDRAWAL_TIME=response.data.CARD.WITHDRAWAL_TIME,$element.removeClass("open"),inputElem.val(""),function(cardNum,cardBalance,cardBalanceActive,cardWithdrawalTime,cardWithdrawalCount){var cardNew='<div class="col-xlg-max-4 col-xlg-5 col-lg-6 col-md-8 col-sm-8 col-xs-12 row-line-col"><div class="elem-card elem-card--cart js-card open"><div class="elem-card__num">№ '+cardNum+'</div><div class="elem-card__fav" data-tooltip title="Сделать любимой" data-ng-click="makeFav($event, '+cardNum+')"><svg aria-hidden="true" class="icon icon-like"><use xlink:href="'+window.stp+'images/required/sprite.svg#like"></use></svg></div><div class="elem-card__fav" data-tooltip title="Скрыть карту" data-popup-inline data-mfp-src="#delete_card_'+cardNum+'"><svg aria-hidden="true" class="icon icon-delete"><use xlink:href="'+window.stp+'images/required/sprite.svg#delete"></use></svg></div><div class="box-popup popup-password mfp-hide" id="delete_card_'+cardNum+"\"><h3 class=\"pb-5\">Скрыть карту</h3><br><p>Данная карта больше не будет видна в вашем личном кабинете, однако вы также сможете делать по ней покупки и использовать бонусы «Hoff бонус».</p><div class=\"elem-btn elem-btn--red text-center\" data-ng-click=\"deleteCard($event, '/bonus/server/cards.php', {'action': 'delete', 'cardnumber': '"+cardNum+'\'})" >Скрыть карту</div></div><div class="elem-card__in"><div class="elem-card__bonus"></div><div class="elem-card__in"><div class="elem-card__bonus">'+cardBalance+"</div>";void 0!==cardWithdrawalTime&&(cardNew+='<div class="elem-card__date text-left color-text">Можно списать '+cardBalanceActive,cardNew+='</div><div class="elem-card__date text-left">Дата сгорания: '+cardWithdrawalTime+" ("+cardWithdrawalCount+")</div>");cardNew+='</div><div class="elem-card__in--info"><div class="elem-card__close js-elem-card-close"><svg aria-hidden="true" class="icon icon-clear"><use xlink:href="'+window.stp+'images/required/sprite.svg#clear"></use></svg></div><br><div class="elem-card__info text-center" style="display: block; height: auto;">Карта '+cardNum+" привязана к вашему аккаунту!</div></div></div></div>",$element.parent().before(cardNew),justAdded=$element.parent().prev(".row-line-col").children(".elem-card"),$timeout(function(){$compile(justAdded.contents())($scope)},0)}(response.data.CARD.NUMBER,response.data.CARD.BALANCE_TEXT,response.data.CARD.BALANCE_ACTIVE_TEXT,response.data.CARD.WITHDRAWAL_TIME,response.data.CARD.WITHDRAWAL_COUNT_TEXT),$('[name="bcnumber"]',$element).val(""),lastCodeNumber=""),$scope.isLoadind=!1,document.querySelector(".updateSession")&&$http({method:"POST",url:"/ajax/get_sessid.php"}).then(function(response){$(".updateSession").val(response.data)}),response.data.CALLBACK)return new Function(response.data.CALLBACK)()},function(){$scope.isLoadind=!1})}function deleteRequest(deleteUrl,myData){$http.post(deleteUrl,myData).then(function(response){if("OK"==response.data.RESULT){var deletedCardId="#delete_card_"+myData.cardnumber;0<$(deletedCardId).length&&$(deletedCardId).magnificPopup("close"),$timeout(function(){$('[data-mfp-src="'+deletedCardId+'"]').closest(".row-line-col").remove()},10)}},function(response){console.error(response)})}$scope.cardNotAdded=!0,$scope.cardAdded=!1,$scope.timeElapsed=!1,$scope.needRegister=!1,$scope.isLoadind=!1,$scope.is_mobile=$(window).width()<1025,$scope.card={},$scope.checkCard=function($event){inputElem=$($event.currentTarget),"_"!=(cardNumber=inputElem.val()).substr(cardNumber.length-1)&&""!=cardNumber&&($timeout(function(){cardRequest()},0),cardNumber)},$scope.checkSms=function($event){"_"!=(codeNumber=$($event.currentTarget).val()).substr(codeNumber.length-1)&&""!=codeNumber&&codeNumber!=lastCodeNumber&&(cardRequest(),lastCodeNumber=codeNumber)},$scope.sendAgain=function(){cardRequest()},$scope.closeCard=function(){$element.removeClass("open"),$scope.hasError=!1,$timeout.cancel(timer),$scope.timeElapsed=!0,$scope.cardNotAdded=!0,$scope.cardAdded=!1},$scope.show_inlinePopup=function(id){$.magnificPopup.open({items:{src:id,type:"inline"},removalDelay:200,closeMarkup:'<button title="%title%" type="button" class="mfp-close"></button>',closeOnBgClick:!1,callbacks:{beforeOpen:function(){$("body").addClass("no-scroll")},open:function(){var _this=this;$timeout(function(){_this.contentContainer[0].className+=" popupIn"},200)},beforeClose:function(){this.contentContainer[0].className+=" popupOut",$("body").removeClass("no-scroll")}}})},$scope.globalCardNum=function(num){formSrv.cardNum=num},$scope.makeFav=function($event,cardnumber){var isActive=(clickedElement=angular.element($event.currentTarget)).hasClass("active"),data=isActive?{block:"loyalty",action:"delete",cardnumber:cardnumber}:{block:"loyalty",action:"favorite",cardnumber:cardnumber};$http.post("/ajax/auth/profile.php",data).then(function(response){"OK"==response.data.RESULT&&($(".elem-card__fav").filter(function(n){return n%2==0}).not(clickedElement).removeClass("active").tooltipster("content","Сделать любимой"),clickedElement.toggleClass("active"),$scope.is_mobile?clickedElement.tooltipster("content","Любимая карта"):clickedElement.tooltipster("content",isActive?"Сделать любимой":"Любимая карта"))},function(){})},$scope.deleteCard=function($event,deleteUrl,data){clickedElement=angular.element($event.currentTarget);var myData={};(myData=data).sessid="",document.querySelector(".updateSession")?$http({method:"POST",url:"/ajax/get_sessid.php"}).then(function(response){myData.sessid=response.data,deleteRequest(deleteUrl,myData)}):deleteRequest(deleteUrl,myData)},$element.on("keyup keypress",function(e){if(13===(e.keyCode||e.which))return e.preventDefault(),!1}),$element.on("click",".js-elem-card-close",function(){$timeout(function(){$scope.closeCard(),""},0)})}]),angular.module("ctrl.basketCardCtrl",[]).controller("basketCardCtrl",["$element","$scope","$http","$attrs","$timeout","$compile","$window","formSrv",function($element,$scope,$http,$attrs,$timeout,$compile,$window,formSrv){var timer,frontData,urlCheckCard,inputElem,cardNumber,lastCardNumber,codeNumber,lastCodeNumber,noBonus=0==$attrs.maxBonusPay;$scope.needRegister=!1,$scope.countDown=!1,$scope.isLoadind=!1,$scope.checkCard=function($event,url,data){urlCheckCard=url,inputElem=$($event.currentTarget),(cardNumber=inputElem.val())&&"_"!=cardNumber.substr(cardNumber.length-1)&&cardNumber!=lastCardNumber&&(frontData=$(":input",$element).serialize()+"&"+toSerialize(data)+"&do_authorize=Y",$timeout(function(){cardRequest(url,frontData)},0),lastCardNumber=cardNumber)},$scope.checkSms=function($event,url){"_"!=(codeNumber=$($event.currentTarget).val()).substr(codeNumber.length-1)&&codeNumber!=lastCodeNumber&&(frontData=$(":input",$element).serialize(),$timeout(function(){cardRequest(url,frontData)},0),lastCodeNumber=codeNumber)};var justAdded,justAdded2,addedTotalCard,bonusPlus="";function cardRequest(url,frontData){$timeout.cancel(timer),$scope.countDown=!1,$scope.noBonus=!1,$scope.hasError=!1,$scope.bigError=!1,$scope.isLoadind=!0,inputElem.blur(),bonusPlus=$element.children(".bonus-plus").html(),$http.post(url,frontData).then(function(response){return $scope.hasError=!1,$scope.bigError=!1,$scope.errorText=null,noBonus?($scope.noBonus=!0,$scope.isLoadind=!1):("ERROR"==response.data.RESULT||response.data.hasOwnProperty("VALIDATE_RESULT")&&"ERROR"==response.data.VALIDATE_RESULT.RESULT?$scope.hasError=!0:"OK"==response.data.RESULT&&($scope.hasError=!1),response.data.MESSAGE&&($scope.errorText=response.data.MESSAGE),response.data.MESSAGE_TEXT&&($scope.errorText=response.data.MESSAGE_TEXT),response.data.hasOwnProperty("DATA")&&response.data.hasOwnProperty("VALIDATE_RESULT")&&"OK"==response.data.VALIDATE_RESULT.RESULT&&($element.removeClass("open"),cardNum=response.data.CARD.NUMBER,cardBalance=response.data.CARD.BALANCE,cardNeedRegister='<div class="col-xlg-4 col-xlg-max-3 col-lg-4 col-md-6 col-xs-12 row-line-col"><div class="elem-card elem-card--cart elem-card--add js-card"><div class="elem-card__num">№ '+cardNum+'</div><div class="elem-card__in"><div class="elem-card__bonus"><div class="elem-card__bonus--num">'+cardBalance+'</div> бонусов</div><div class="elem-card__date text-left js-elem-btn underline" data-popup-inline data-mfp-src="#popup_Bonus" ng-click="globalCardNum(\''+cardNum+'\')">Для списания бонусов с этой карты необходимо <br>зарегистрировать анкету участника Hoff бонус</div></div><div class="elem-card__in--info"><div class="elem-card__close js-elem-card-close"><svg aria-hidden="true" class="icon icon-clear"><use xlink:href="'+window.stp+'images/required/sprite.svg#clear"></use></svg></div><div class="elem-card__info text-center" style="display: block; height: auto;">Для списания бонусов с этой карты необходимо зарегистрировать анкету участника Hoff бонус. <br>Заполните <a href="/bonus/registration/" target="_blank">анкету на сайте</a> или обратитесь в магазин Hoff на стойку сервиса. Через 2 дня, после регистрации, вы сможете использовать доступные для списания бонусы.</div></div><div class="elem-card__status" data-ng-show="!couponActive && !promocodeActive && paySystem !== 11">'+bonusPlus+"</div></div></div>",$element.parent().before(cardNeedRegister),justAdded=$element.parent().prev(".row-line-col").children(".elem-card"),$timeout(function(){$compile(justAdded.contents())($scope),$timeout.cancel(timer),$scope.countDown=!1},0),$('[name="bcnumber"]',$element).val("")),"OK"==response.data.RESULT&&response.data.hasOwnProperty("DATA")&&0<response.data.DATA.CardProcessingType&&3!=response.data.DATA.CardProcessingType&&($element.removeClass("open"),function(cardNum,cardBalance){var cardRealMag='<div class="col-xlg-4 col-xlg-max-3 col-lg-4 col-md-6 col-xs-12 row-line-col"><div class="elem-card elem-card--cart elem-card--add js-card"><div class="elem-card__num">№ '+cardNum+'</div><div class="elem-card__in"><div class="elem-card__bonus"><div class="elem-card__bonus--num">'+cardBalance+'</div> бонусов</div><div class="elem-card__date text-left">Скидка по данной карте предоставляется только в розничных магазинах</div></div><div class="elem-card__in--info"></div><div class="elem-card__status" data-ng-show="!couponActive && !promocodeActive && paySystem !== 11">'+bonusPlus+"</div></div></div>";$element.parent().before(cardRealMag),justAdded2=$element.parent().prev(".row-line-col").children(".elem-card"),$timeout(function(){$compile(justAdded2.contents())($scope),$timeout.cancel(timer),$scope.countDown=!1},0)}(response.data.CARD.NUMBER,response.data.CARD.BALANCE),$('[name="bcnumber"]',$element).val("")),(response.data.hasOwnProperty("CONFIRM_RESULT")&&"NO_PHONE"==response.data.CONFIRM_RESULT.CODE||$scope.errorText&&40<$scope.errorText.length)&&($scope.hasError=!0,$scope.bigError=!0),response.data.hasOwnProperty("CONFIRM_RESULT")&&0<response.data.CONFIRM_RESULT.REMAIN_TIME&&($scope.timeElapsed=!1,$scope.timeRemainText=response.data.MESSAGE_TEXT,$scope.countDown=!0,$timeout(function(){startTimer(response.data.CONFIRM_RESULT.REMAIN_TIME,$(".timer-error")),sendAgainTimer(response.data.CONFIRM_RESULT.REMAIN_TIME+2)},0)),response.data.hasOwnProperty("CONFIRM_RESULT")&&"CONFIRMED"==response.data.CONFIRM_RESULT.CODE&&pasteTotalCard(response.data.HTML,!0),toJSON(frontData).hasOwnProperty("code")&&"ERROR"==response.data.STATUS&&($scope.timeElapsed=!1,$scope.timeRemainText=response.data.MESSAGE_TEXT,$scope.countDown=!0,$timeout(function(){startTimer(response.data.REMAIN_TIME,$(".timer-error")),sendAgainTimer(response.data.REMAIN_TIME+2)},0)),toJSON(frontData).hasOwnProperty("code")&&"OK"==response.data.STATUS&&confirmCard(),$scope.isLoadind=!1,response.data.CALLBACK?new Function(response.data.CALLBACK)():void 0);var cardNum,cardBalance,cardNeedRegister},function(){$scope.isLoadind=!1})}function confirmCard(){frontData=$(":input",$element).serialize()+"&action=card_balance&clearcache=1&smsconfirm=1",$scope.isLoadind=!0,$http.post(urlCheckCard,frontData).then(function(response){if(pasteTotalCard(response.data.HTML),$scope.isLoadind=!1,response.data.CALLBACK)return new Function(response.data.CALLBACK)()},function(){$scope.isLoadind=!1})}function sendAgainTimer(time){timer=$timeout(function(){$scope.timeElapsed=!0},1e3*time)}function pasteTotalCard(cardLayout,noremove){if($element.parent().before(cardLayout),$timeout(function(){addedTotalCard=$element.parent().prev(".row-line-col").children(".elem-card, .elem-card__status"),compileDom(addedTotalCard),addedTotalCard.trigger("click"),$timeout.cancel(timer),$scope.countDown=!1},0),$element.parent().prev(".row-line-col").children(".elem-card").after('<div class="elem-card__status" data-ng-show="!couponActive && !promocodeActive && paySystem !== 11">'+bonusPlus+"</div>"),noremove)return $element.removeClass("open"),$('[name="bcnumber"]',$element).val(""),!1;$timeout(function(){$element.parent().remove()},1)}$scope.sendAgain=function(url,data){frontData=$(":input",$element).serialize()+"&"+toSerialize(data),$timeout(function(){cardRequest(url,frontData)},0)},$scope.closeCard=function(){$element.removeClass("open"),$timeout.cancel(timer),$scope.timeElapsed=!0,$scope.needRegister=!1},$scope.globalCardNum=function(num){formSrv.cardNum=num}}]),angular.module("ctrl.cardConfirm",[]).controller("cardConfirm",["$element","$scope","$http","$timeout","$compile",function($element,$scope,$http,$timeout,$compile){var timer,frontData,codeNumber,lastCodeNumber,cardModel;function cardRequest(url,frontData){$timeout.cancel(timer),$scope.countDown=!1,$scope.noPhone=!1,$scope.isLoadind=!0,$http.post(url,frontData).then(function(response){if(response.data.MESSAGE&&($scope.errorText=response.data.MESSAGE),response.data.MESSAGE_TEXT&&($scope.errorText=response.data.MESSAGE_TEXT),response.data.hasOwnProperty("CONFIRM_RESULT")&&0<response.data.CONFIRM_RESULT.REMAIN_TIME&&($scope.timeElapsed=!1,$scope.timeRemainText=response.data.MESSAGE_TEXT,$scope.countDown=!0,$timeout(function(){startTimer(response.data.CONFIRM_RESULT.REMAIN_TIME,$(".timer-error")),sendAgainTimer(response.data.CONFIRM_RESULT.REMAIN_TIME+2)},0)),response.data.hasOwnProperty("CONFIRM_RESULT")&&"NO_PHONE"==response.data.CONFIRM_RESULT.CODE&&($scope.noPhone=!0),toJSON(frontData).hasOwnProperty("code")&&"ERROR"==response.data.STATUS&&($scope.timeElapsed=!1,$scope.timeRemainText=response.data.MESSAGE_TEXT,$scope.countDown=!0,$timeout(function(){startTimer(response.data.REMAIN_TIME,$(".timer-error")),sendAgainTimer(response.data.REMAIN_TIME+2)},0)),toJSON(frontData).hasOwnProperty("code")&&"OK"==response.data.STATUS){$scope.confirmedCard=!0,window.activeBalanceCardInCart=$element.data("cardNum"),$element.removeClass("open");var cardModel=$('[data-card-num="'+toJSON(frontData).bcnumber+'"]').find("[data-slider]").data("ngModel");$scope.$emit("updateTotal",$scope[cardModel]),$element.find(".range-field").children("input.form-control")[0].disabled=!1,$scope.makePost()}if($scope.isLoadind=!1,toJSON(frontData).hasOwnProperty("code")&&"OK"==response.data.STATUS&&!0===response.data.AUTHORIZE){var data=response.data.SEARCH_HTML,elem=angular.element(data);angular.element(document.getElementById("box_search")).html($compile(elem)($scope))}if(response.data.CALLBACK)return new Function(response.data.CALLBACK)()},function(){$scope.isLoadind=!1})}function sendAgainTimer(time){timer=$timeout(function(){$scope.timeElapsed=!0},1e3*time)}$scope.countDown=!1,$scope.timeElapsed=!1,$scope.isLoadind=!1,$scope.confirmCard=function($event,url,data){angular.element($event.currentTarget),frontData=$(":input",$element).serialize()+"&"+toSerialize(data),$timeout(function(){cardRequest(url,frontData)},0)},$scope.checkSms=function($event,url,data){"_"!=(codeNumber=$($event.currentTarget).val()).substr(codeNumber.length-1)&&codeNumber!=lastCodeNumber&&(frontData=$(":input",$element).serialize()+"&"+toSerialize(data),$timeout(function(){cardRequest(url,frontData)},0),lastCodeNumber=codeNumber)},$scope.sendAgain=function(url,data){frontData=$(":input",$element).serialize()+"&"+toSerialize(data),$timeout(function(){cardRequest(url,frontData)},0)},$element.click(function(){var _this=this;$timeout(function(){$(_this).hasClass("card-confirmed")&&$(_this).hasClass("active")&&!$(_this).hasClass("elem-card--disabled")?(cardModel=$(_this).find("[data-slider]").data("ngModel"),$scope.$emit("updateTotal",$scope[cardModel])):$scope.$emit("updateTotal",0)},100)})}]),angular.module("ctrl.registerCardCtrl",[]).controller("registerCardCtrl",["$element","$scope","$http","$attrs","$timeout","$compile","formSrv",function($element,$scope,$http,$attrs,$timeout,$compile,formSrv){var frontData,urlCheckCard,captchaOpt;if($scope.formSrv=formSrv,$attrs.recaptchaElem&&""!=window.captchaKey){$element.addClass("has-loader"),$element.append('<div id="'+$attrs.recaptchaElem+'" />');var attempt=1;setTimeout(function run(){30!=attempt&&("object"==typeof grecaptcha&&"function"==typeof grecaptcha.render?(captchaOpt=grecaptcha.render($attrs.recaptchaElem,{sitekey:window.captchaKey,callback:captchaSubmit,size:"invisible"}),$element.removeClass("has-loader"),attempt=30,$(document).find('iframe[title*="recaptcha"]').parent().hide()):(attempt++,setTimeout(run,1e3)))},1e3),$timeout(function(){$element.removeClass("has-loader")},2e4)}var inputElem,cardNumber,lastCardNumber,paramData,captchaSubmit=function(token){frontData=$(":input",$element).serialize()+"&"+$("textarea",$element).serialize()+"&"+toSerialize(paramData),cardRequest(urlCheckCard,frontData)};function cardRequest(url,frontData){$element.addClass("has-loader"),inputElem.blur(),$http.post(url,frontData).then(function(response){if($scope.message=response.data.MESSAGE?response.data.MESSAGE:"",$scope.isError=!!response.data.IS_ERROR&&response.data.IS_ERROR,"EXIST"==response.data.RESULT?($scope.cardNeedRegister=!1,$(".js-dynamic-form").hide(),$scope.cardRegistered=!0,$scope.customMessage=!1,$scope.CardActiveBalance=response.data.balance.DATA.CardActiveBalance,$scope.TakeBalance=response.data.balance.DATA.CardBalance-response.data.balance.DATA.CardActiveBalance,$scope.CardBalance=response.data.balance.DATA.CardBalance):"OK"==response.data.RESULT?($scope.cardNeedRegister=!0,$(".js-dynamic-form").show(),$scope.cardRegistered=!1,$scope.customMessage=!1):($scope.cardNeedRegister=!1,$(".js-dynamic-form").hide(),$scope.cardRegistered=!1,$scope.customMessage=!0),response.data.hasOwnProperty("DATA")&&response.data.DATA.WITHDRAWAL&&($scope.burnBonus=response.data.DATA.WITHDRAWAL.COUNT,$scope.burnTime=response.data.DATA.WITHDRAWAL.FORMAT_DATE),$element.removeClass("has-loader"),document.querySelector('[name="sessid"]')&&$http({method:"POST",url:"/ajax/get_sessid.php"}).then(function(response){$('[name="sessid"]').val(response.data)}),response.data.CALLBACK)return new Function(response.data.CALLBACK)()},function(){$element.removeClass("has-loader")})}$scope.cardNeedRegister=!1,$scope.cardNotFound=!1,$scope.cardRegistered=!1,$scope.checkCard=function($event,url,data){urlCheckCard=url,paramData=data,inputElem=$($event.currentTarget),"_"!=(cardNumber=inputElem.val()).substr(cardNumber.length-1)&&""!=cardNumber||($scope.cardNeedRegister=!1,$(".js-dynamic-form").hide(),$scope.cardNotFound=!1,$scope.cardRegistered=!1,lastCardNumber=0),"_"!=cardNumber.substr(cardNumber.length-1)&&""!=cardNumber&&cardNumber!=lastCardNumber&&($attrs.recaptchaElem&&""!=window.captchaKey&&"object"==typeof grecaptcha&&"function"==typeof grecaptcha.execute?(grecaptcha.reset(captchaOpt),grecaptcha.execute(captchaOpt).then(function(){})):cardRequest(url,frontData=inputElem.closest("form").hasClass("updateSession")?inputElem.closest("form").serialize()+"&"+toSerialize(data):$(":input",$element).serialize()+"&"+toSerialize(data)),$scope.formSrv.cardNum=cardNumber,lastCardNumber=cardNumber)},$scope.isError=!1,$scope.message=""}]),angular.module("ctrl.dzCtrl",[]).controller("dzCtrl",["$element","$scope","$timeout","$attrs",function($element,$scope,$timeout,$attrs){var jsonResponse,url=$attrs.url,_maxFiles=$attrs.maxFiles?$attrs.maxFiles:1,_maxSize=$attrs.maxSize?$attrs.maxSize:1024,fileName=$attrs.fileName?$attrs.fileName:"file",iconFile=$attrs.iconPath?window.stp+$attrs.iconPath:window.stp+"images/required/files.svg",subText=$attrs.subText?$attrs.subText:"",mainText=$attrs.mainText?'<span class="file-message"><span class="with-sub-text" data-subtext="'+subText+'">'+$attrs.mainText+"</span></span>":'<span class="file-message"><span class="hidden-xs with-sub-text" data-subtext="'+subText+'">Перетащите сюда или <span class="color-blue">загрузите</span> файлы</span><span class="visible-xs color-blue">Загрузите файл</span></span>',_acceptedFiles=null;if($attrs.accept&&(_acceptedFiles=$attrs.accept),1<_maxFiles)for(var i=0;i<_maxFiles;i++)$("<input />").attr("type","hidden").attr("name",fileName+"["+i+"]").appendTo($element);else $element.children("[name="+fileName+"]").length||$("<input />").attr("type","hidden").attr("name",fileName).appendTo($element);$element.attr("required")&&$element.children("input[type='hidden']").first().attr("required",""),$element.children(".elem-dropzone__error").length||$('<div class="elem-dropzone__error" />').appendTo($element),$scope.dzOptions={url:url,paramName:"file",maxFilesize:_maxSize,maxFiles:_maxFiles,acceptedFiles:_acceptedFiles,addRemoveLinks:!0,dictRemoveFile:"Удалить файл",dictDefaultMessage:'<img src="'+iconFile+'" class="file-icon">'+mainText,dictMaxFilesExceeded:"Возможно загрузить файлов: "+_maxFiles+" шт.",dictFileTooBig:"Этот файл больше "+_maxSize+" Мб",dictInvalidFileType:"Неверный формат файла"},$scope.dzCallbacks={uploadprogress:function(file,progress){$(".dz-preview").not(".dz-complete").addClass("has-loader"),100===progress&&$(".dz-preview").removeClass("has-loader")},totaluploadprogress:function(progress){$("button[type='submit']").attr("disabled","disabled"),100===progress&&$timeout(function(){$("button[type='submit']").removeAttr("disabled")},1e3)},addedfile:function(file){if($element.hasClass("search")&&$("body").addClass("has-loader"),$element.removeClass("has-error"),$element.children(".elem-dropzone__error").text(""),$scope.newFile=file,$element.children(".dz-default").length&&$element.children(".dz-default").remove(),angular.isDefined($attrs.accept)&&$attrs.accept.indexOf(file.type)<0||!file.type){return $element.children(".elem-dropzone__error").text("Неверный формат файла."),$scope.removeNewFile(),$("body").removeClass("has-loader"),!1}if(file.size/1048576>parseFloat(_maxSize)){var sizeError="Размер файла превышает "+_maxSize+" MB";return $element.children(".elem-dropzone__error").text(sizeError),$scope.removeNewFile(),$("body").removeClass("has-loader"),!1}},maxfilesexceeded:function(){$element.children(".elem-dropzone__error").text(""),$element.children(".elem-dropzone__error").text("Возможно загрузить файлов: "+_maxFiles+" шт."),$scope.removeNewFile()},success:function(file,xhr){if((jsonResponse=JSON.parse(xhr)).error&&"y"==jsonResponse.error.max_file_size&&$timeout(function(){$(file.previewElement).find(".dz-error-message").text("Превышен размер файла"),$(file.previewElement).removeClass("dz-success").addClass("dz-error")},100),jsonResponse.file_id)if(file.file_id=jsonResponse.file_id,1<_maxFiles){for(var i=0;i<_maxFiles;i++)if(""==$element.children('[name="'+fileName+"["+i+']"]').val()){$element.children('[name="'+fileName+"["+i+']"]').val(jsonResponse.file_id);break}}else $element.children('[name="'+fileName+'"]').val(jsonResponse.file_id);else jsonResponse.REDIRECT_URL&&($("body").addClass("has-loader"),location.href=jsonResponse.REDIRECT_URL)},removedfile:function(file){if(file.file_id){if(1<_maxFiles){for(var i=0;i<_maxFiles;i++)if($element.children('[name="'+fileName+"["+i+']"]').val()==file.file_id){$element.children('[name="'+fileName+"["+i+']"]').val("");break}}else $element.children('[name="'+fileName+'"]').val("");$element.children(".elem-dropzone__error").text("")}}},$scope.dzMethods={},$scope.removeNewFile=function(){$scope.dzMethods.removeFile($scope.newFile)},$(".dz-remove",$element).click(function(){$(this).closest(".dz-default").remove(),$element.children('[name="'+fileName+'"]').val("")}),$scope.$on("dropFiles",function(event,data){if($element.children(".dropzone").children(".dz-preview").remove(),1<_maxFiles)for(var i=0;i<_maxFiles;i++)$element.children('[name="'+fileName+"["+i+']"]').val("");else $element.children('[name="'+fileName+'"]').val("");Dropzone.forElement(".dropzone").files=[],$element.children(".elem-dropzone__error").text("")})}]),angular.module("ctrl.dateCtrl",[]).controller("dateCtrl",["$element","$scope","$attrs","$timeout","$rootScope",function($element,$scope,$attrs,$timeout,$rootScope){$attrs.setDate&&($scope.date=moment($attrs.setDate,"DD-MM-YYYY",!0),$scope.dateDay=$scope.date.day()),$attrs.minDate&&($scope.mindate=moment($attrs.minDate,"DD-MM-YYYY",!0)),$attrs.maxDate&&($scope.maxdate=moment($attrs.maxDate,"DD-MM-YYYY",!0)),$scope.onChange=function(newValue,oldValue){$scope.dateDay=moment(newValue).day(),$timeout(function(){try{$(".selectpicker").selectpicker("refresh")}catch(e){}},0)},$scope.$watch("date",function(newValue,oldValue){newValue!==oldValue&&$rootScope.$broadcast("date_changed",newValue.toDate())},!0),$scope.isSelectable=function(date,type,exceptDays){return"day"!=type||-1===exceptDays.indexOf(moment(date).day())}}]),angular.module("ctrl.omniCtrl",[]).controller("omniCtrl",["$element","$scope","$http","$attrs","$timeout","$compile",function($element,$scope,$http,$attrs,$timeout,$compile){var url=$element.children("form").attr("action"),method=$element.children("form").attr("method"),formElem=$element.children("form");$scope.canClear=!1;var options_success=function(response){if(formElem.removeClass("has-loader"),response.data.CLEAR&&1==response.data.CLEAR&&formElem[0].reset(),!1===response.data.RESULT?(response.data.ERRORS&&$.map(response.data.ERRORS,function(val,i){$('[name="'+i+'"]',formElem).parent().addClass("has-error"),$('[name="'+i+'"]',formElem).parent().children(".form-field__error-msg").html(val)}),$(".form-field__error-total",formElem).removeClass("success")):($(".form-field__error-total",formElem).addClass("success"),$(".form-field",formElem).removeClass("has-error"),response.data.REDIRECT_URL&&(location.href=response.data.REDIRECT_URL)),response.data.MESSAGE&&!response.data.POPUP?$(".form-field__error-total",formElem).html('<br><div class="form-field__error-title">'+response.data.MESSAGE.TITLE+'</div><p class="form-field__error-text">'+response.data.MESSAGE.TEXT+"</p>"):response.data.MESSAGE&&response.data.POPUP?$.magnificPopup.instance.isOpen?($.magnificPopup.close(),$timeout(function(){generatePopup(response.data.MESSAGE)},200)):generatePopup(response.data.MESSAGE):$(".form-field__error-total",formElem).html(""),response.data.CALLBACK)return new Function(response.data.CALLBACK)()};$scope.addToCart=function(url,data,$event){$scope.spinner=!0,$http.post(url,data).then(function(response){null!=response.data.itemId?($(angular.element($event.currentTarget)).closest(".form-field").removeClass("has-error"),$scope.reloadBasket()):$(angular.element($event.currentTarget)).closest(".form-field").addClass("has-error"),$scope.articulName="",$scope.spinner=!1},function(){$scope.spinner=!1})},$scope.getItems=function(geturl){$scope.geturl=geturl,$http.get($scope.geturl).then(function(response){$(".b-hmOrder-items").html(response.data),$timeout(function(){compileDom(".b-hmOrder-items"),$scope.updateOrderPrice();try{myLazyLoad.update()}catch(e){}},1)},function(){})},$scope.reloadBasket=function(){$http.get($scope.geturl).then(function(response){$(".b-hmOrder-items").html(response.data),$timeout(function(){compileDom(".b-hmOrder-items"),$scope.updateOrderPrice()},1)},function(){})},$scope.updateOrderPrice=function(){$http.post("/ajax/get_order_price.php",{DELIVERY_ID:2}).then(function(response){$scope.totalPrice=response.data.totalPrice,0<$(".b-hmOrder-items",$element).children(".elem-table").children("tbody").children().length?$scope.canClear=!0:$scope.canClear=!1},function(){})},$scope.updateItems=function(url,data){$scope.tableLoader=!0,$http.post(url,data).then(function(response){$(".b-hmOrder-items").html(response.data),$timeout(function(){compileDom(".b-hmOrder-items"),$scope.updateOrderPrice(),$scope.tableLoader=!1},1)},function(){$scope.tableLoader=!1})},$scope.$on("callMakePost",function(event,args){$(".elem-city__current").text(args.LOCATION_NAME),location.reload()}),$element.on("keyup keypress",function(e){if(13===(e.keyCode||e.which))return e.preventDefault(),!1}),$element.children("form").validate({errorElement:"div",submitHandler:function(form){("false"==$(".b-hmOrder-items").children("table").data("available")||0==$(".b-hmOrder-items").children("table").children("tbody").children("tr").length)&&dataLayer.push({event:"OWOX_Forms",timingCategory:"Forms",timingVar:"send",timingValue:window.submitTime-window.firstInputTimestamp,timingLabel:"unsuccessful",eventContent:$element.children("form").attr("name"),eventLocation:null,eventContext:"notAllAvailable",eventPosition:window.orderFormSubmitAttempts?window.orderFormSubmitAttempts:"0"}),formElem.addClass("has-loader"),$http({method:method,url:url,data:$element.children("form").serialize()}).then(options_success)},invalidHandler:function(event,validator){if(validator.numberOfInvalids()){dataLayer.push({event:"OWOX_Forms",timingCategory:"Forms",timingVar:"send",timingValue:window.submitTime-window.firstInputTimestamp,timingLabel:"unsuccessful",eventContent:$element.children("form").attr("name"),eventLocation:null,eventContext:!1,eventPosition:window.orderFormSubmitAttempts?window.orderFormSubmitAttempts:"0"});var shaObj=new jsSHA("SHA-256","TEXT");shaObj.update($(".email-input",$element).val());var email_hash=shaObj.getHash("B64"),shaObj2=new jsSHA("SHA-256","TEXT");shaObj2.update($(".phone-input",$element).val());var phone_hash=shaObj2.getHash("B64");dataLayer.push({event:"OWOX",eventCategory:"Conversions",eventAction:"click",eventLabel:"makeOrder",eventContent:null,eventContext:"unsuccessful",eventPosition:null,eventLocation:null,eventCategoryGroupName:null,eventCategoryName:null,eventCategoryId:null,eventProductName:null,eventProductPrice:null,userEmailHash:email_hash||null,userPhonelHash:phone_hash||null,ecommerce:{checkout:{actionField:{step:"2",option:"Оформление"},products:[window.checkoutProducts]}}})}},errorPlacement:function(error,element){$(element).parent().addClass("has-error")},highlight:function(element,errorClass){$(element).parent().removeClass("has-error")},unhighlight:function(element,errorClass,validClass){$(element).parent().removeClass("has-error")}});var popupConfig={removalDelay:200,key:"pAnswer",items:{},type:"inline",closeMarkup:'<button title="%title%" type="button" class="mfp-close"></button>',closeOnBgClick:!1,callbacks:{beforeOpen:function(){$("body").addClass("no-scroll")},open:function(){var _this=this;$timeout(function(){_this.contentContainer[0].className+=" popupIn"},200)},beforeClose:function(){this.contentContainer[0].className+=" popupOut",$("body").removeClass("no-scroll")},afterClose:function(){delete $.magnificPopup.instance.popupsCache.pAnswer}},inline:{markup:""}};function generatePopup(data){data.TITLE&&""!=data.TITLE?popupConfig.inline.markup='<div class="box-popup popup-password"><button title="Закрыть (Esc)" type="button" class="mfp-close"></button><div class="box-popup__name">'+data.TITLE+"</div><br><div>"+data.TEXT+"</div></div>":popupConfig.inline.markup='<div class="box-popup popup-password"><button title="Закрыть (Esc)" type="button" class="mfp-close"></button><div>'+data.TEXT+"</div></div>",$.magnificPopup.open(popupConfig)}}]),angular.module("ctrl.giftCtrl",[]).controller("giftCtrl",["$element","$scope","$http","$compile","$timeout",function($element,$scope,$http,$compile,$timeout){var popupConfig={removalDelay:200,key:"pCart",items:{},type:"inline",closeMarkup:'<button title="%title%" type="button" class="mfp-close"></button>',closeOnBgClick:!($scope.addItem=function(url,frontData){pagePreloader(!0),$http.post(url,frontData).then(function(response){$.magnificPopup.instance.isOpen?($.magnificPopup.close(),$timeout(function(){generatePopup(response.data)},200)):generatePopup(response.data),pagePreloader(!1)},function(){pagePreloader(!1)})}),callbacks:{beforeOpen:function(){$("body").addClass("no-scroll")},open:function(){var _this=this;$compile(this.content)($scope),$(this.contentContainer).children(".box-popup").append('<button title="Закрыть (Esc)" type="button" class="mfp-close"></button>'),$timeout(function(){_this.contentContainer[0].className+=" popupIn"},200)},beforeClose:function(){this.contentContainer[0].className+=" popupOut",$("body").removeClass("no-scroll")},afterClose:function(){delete $.magnificPopup.instance.popupsCache.pCart}},inline:{markup:""}};function generatePopup(data){popupConfig.inline.markup=data,$.magnificPopup.open(popupConfig),$timeout(function(){try{myLazyLoad.update()}catch(e){}},1)}}]),angular.module("ctrl.bikCtrl",[]).controller("bikCtrl",["$element","$scope","$http",function($element,$scope,$http){var bikNumber;function bikRequest(url,data){$http.post(url,data).then(function(response){response.data.NAME&&($scope.bankModel=response.data.NAME)},function(){})}$scope.checkBik=function($event,url,data){bikNumber=data.bik,(48<=$event.keyCode&&$event.keyCode<=57||96<=$event.keyCode&&$event.keyCode<=105)&&bikNumber&&"_"!=data.bik.substr(bikNumber.length-1)&&bikRequest(url,data),86==$event.keyCode&&bikNumber&&"_"!=data.bik.substr(bikNumber.length-1)&&bikRequest(url,data)}}]),angular.module("ctrl.bonusCtrl",[]).controller("bonusCtrl",["$element","$scope","$http","$timeout","$compile","formSrv",function($element,$scope,$http,$timeout,$compile,formSrv){var timer;$scope.timeElapsed=!0,$scope.cardNeedRegister=!1,$scope.allowConfirm=!1,$scope.message="",$scope.cardsCollection="",$scope.maskedPhoneNumber="",formSrv.phoneConfirmed=!1;var frontData,favIds,phoneNumber,confirmedNumber="";function sendAgainTimer(time){timer=$timeout(function(){$scope.timeElapsed=!0,$scope.customMessage=!1,$scope.allowConfirm=!0,confirmedNumber=""},1e3*time)}function initAccordBonus(){var sectionWrapper,singleSection;sectionWrapper=$(".box-balance__cards-wrapper",$element),(singleSection=sectionWrapper.children(".box-balance__item")).first().addClass("opened"),singleSection.children(".bb--num").click(function(){$(this).parent().hasClass("opened")?$(this).parent().removeClass("opened"):(singleSection.removeClass("opened"),$(this).parent().addClass("opened"))})}$($element).on("keypress",'input[name="code"]',function(e){13!==(e.keyCode||e.which)||$scope.timeElapsed||$(this).parent().find(".elem-btn").click()}),$scope.confirmNumber=function(url,data){$element.addClass("has-loader"),frontData=$element.children("form").serialize()+"&"+toSerialize(data),null!==localStorage.getItem("favObj")&&0!==JSON.parse(localStorage.getItem("favObj")).length&&(favIds=JSON.parse(localStorage.getItem("favObj")).join(","),frontData+="&fav_ids="+favIds),$scope.cardNum=$element.find("[name='cardnumber']").val(),$timeout.cancel(timer),$http.post(url,frontData).then(function(response){if($element.removeClass("has-loader"),$scope.customMessage=!1,$scope.cardNeedRegister=!1,$(".js-dynamic-form").hide(),$scope.cardsCollection=$scope.cardsCollection||"",response.data.PHONE&&($scope.maskedPhoneNumber="****"+response.data.PHONE.toString().slice(-3)),response.data.MESSAGE?$scope.infoText=response.data.MESSAGE:response.data.message&&($scope.infoText=response.data.message),"ERROR"!=response.data.RESULT&&!1!==response.data.RESULT||($scope.customMessage=!0,$scope.phoneConfirmed=!1,formSrv.phoneConfirmed=!1),("send"==response.data.status||"send"==response.data.status&&"ERROR"==response.data.RESULT)&&($scope.timeElapsed=!1,$scope.customMessage=!1,$scope.allowConfirm=!1,$element.find('[name="phone"]').length?confirmedNumber=$element.find('[name="phone"]').val():$element.find('[name="cardnumber"]').length&&(confirmedNumber=$element.find('[name="cardnumber"]').val()),$timeout(function(){document.querySelector('input[name="code"].'+$scope.checkType)&&angular.element(document.querySelector('input[name="code"].'+$scope.checkType)).focus()},50),$timeout(function(){startTimer(response.data.REMAIN_TIME,$(".send-counter",$element)),sendAgainTimer(+response.data.REMAIN_TIME+2)},0)),"wrongCode"==response.data.status&&($scope.timeElapsed=!1,response.data.REMAIN_TIME&&$timeout(function(){startTimer(response.data.REMAIN_TIME,$(".send-counter",$element)),sendAgainTimer(+response.data.REMAIN_TIME+2)},1)),"already_send"==response.data.status&&($scope.timeElapsed=!1,$scope.customMessage=!1,$timeout(function(){document.querySelector('input[name="code"]')&&angular.element(document.querySelector('input[name="code"]')).focus()},50),$timeout(function(){startTimer(response.data.REMAIN_TIME,$(".send-counter",$element)),sendAgainTimer(+response.data.REMAIN_TIME+2)},0)),"maxAttemptsExceed"==response.data.status&&($scope.timeElapsed=!0,$scope.allowConfirm=!1),response.data.REMAIN_TIME&&$timeout(function(){startTimer(response.data.REMAIN_TIME,$(".send-counter",$element)),sendAgainTimer(+response.data.REMAIN_TIME+2)},0),"success"==response.data.status&&($scope.timeElapsed=!0,$scope.phoneConfirmed=!0,$scope.cardConfirmed=!0,formSrv.phoneConfirmed=!0,$element.find('[name="phone"]').length?confirmedNumber=$element.find('[name="phone"]').val():$element.find('[name="cardnumber"]').length&&(confirmedNumber=$element.find('[name="cardnumber"]').val())),"success"==response.data.status&&!0===response.data.AUTHORIZE){var data=response.data.SEARCH_HTML,mobileData=response.data.MOBILE_HEADER_HTML,elem=angular.element(data),elemMobile=angular.element(mobileData);angular.element(document.getElementById("box_search")).html($compile(elem)($scope)),angular.element(document.querySelector(".mobile-cabinet-cart")).html($compile(elemMobile)($scope))}"NEED_REGISTER"==response.data.status&&($scope.phoneConfirmed=!1,$scope.cardNeedRegister=!0,$(".js-dynamic-form").show(),$scope.timeElapsed=!0,formSrv.cardNum=$scope.cardNum),response.data.HTML_CARDS&&($scope.cardsCollection=response.data.HTML_CARDS,$timeout(function(){initAccordBonus()},10)),"ERROR"==response.data.RESULT&&"wrongCode"==response.data.status&&($scope.timeElapsed=!1,$scope.customMessage=!1),document.querySelector('[name="sessid"]')&&$http({method:"POST",url:"/ajax/get_sessid.php"}).then(function(response){$('[name="sessid"]').val(response.data)})},function(){$element.removeClass("has-loader")})},$scope.reconfirm=function($event){"_"!=(phoneNumber=$($event.currentTarget).val()).substr(phoneNumber.length-1)&&(confirmedNumber!=phoneNumber?($scope.phoneConfirmed=!1,$scope.cardConfirmed=!1,formSrv.phoneConfirmed=!1,$scope.allowConfirm=!0):""!=phoneNumber&&confirmedNumber==phoneNumber?($scope.phoneConfirmed=!0,$scope.cardConfirmed=!0,formSrv.phoneConfirmed=!0):$scope.allowConfirm=!1),13===($event.keyCode||$event.which)&&$timeout(function(){$($event.currentTarget).parent().find(".elem-btn").click()},0)},$(".box-balance__cards-wrapper").length&&initAccordBonus()}]),angular.module("ctrl.selectChangeOnDateCtrl",[]).controller("selectChangeOnDateCtrl",["$element","$scope","$attrs","$timeout","$rootScope",function($element,$scope,$attrs,$timeout,$rootScope){$scope.timeOptlist=[],$scope.startHour="",$scope.endHour="",$scope.nowHour="",$scope.targetHour="",$scope.generateHours=function(startPointHour){if($scope.timeOptlist=[],startPointHour<=$scope.endHour)for(var i=startPointHour;i<=$scope.endHour;i++){if(startPointHour==$scope.endHour-1){$scope.timeOptlist=[];timeOpt="Выберите другую дату визита";$scope.timeOptlist.push(timeOpt);break}var timeOpt=i+":00-"+(i+1)+":00";$scope.timeOptlist.push(timeOpt)}else{timeOpt="Выберите другую дату визита";$scope.timeOptlist.push(timeOpt)}setTimeout(function(){$(".selectpicker").selectpicker("refresh")},10)},$scope.generateHours($scope.nowHour),$rootScope.$on("date_changed",function(event,data){var currentTime=new Date,broadcastedVal=data;currentTime.getMonth()+1==broadcastedVal.getMonth()+1&&currentTime.getDate()==broadcastedVal.getDate()&&currentTime.getFullYear()==broadcastedVal.getFullYear()&&$scope.startHour-1<=$scope.nowHour?$scope.generateHours($scope.targetHour):$scope.generateHours($scope.startHour)})}]),angular.module("ctrl.bestOffersCtrl",[]).controller("bestOffersCtrl",["$element","$scope","$attrs",function($element,$scope,$attrs){$scope.activeOffer=[!0,!1,!1,!1,!1],$scope.totalOffers=0,function(){for(var i=0;i<$scope.activeOffer.length;i++)!0===$scope.activeOffer[i]&&$scope.totalOffers++}(),$scope.removeOffer=function(index){$scope.activeOffer[index]=!1,$scope.totalOffers--},$scope.addOffer=function(){for(var i=0;i<$scope.activeOffer.length;i++)if(!1===$scope.activeOffer[i]){$scope.activeOffer[i]=!0,$scope.totalOffers++;break}}}]);